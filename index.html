<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ä¼´ Go! æ—…éŠè¦åŠƒ V3.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4e54c8; /* ä¸»è‰²èª¿ï¼šè³ªæ„Ÿè—ç´« */
            --secondary: #8f94fb;
            --accent: #ff6b6b;
            --bg: #f0f2f5;
            --sidebar-width: 250px;
        }

        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ================= æ­¡è¿é é¢ (Landing Page) ================= */
        #landing-page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            transition: transform 0.5s ease-in-out;
        }

        .landing-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            color: #333;
            max-width: 400px;
            width: 90%;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-direction: column;
        }

        .big-btn {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: bold;
        }

        .btn-create { background: var(--primary); color: white; }
        .btn-join { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .big-btn:hover { transform: scale(1.03); }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        /* ================= è¦åŠƒä¸»é é¢ (Planner Page) ================= */
        #planner-page {
            display: none; /* é è¨­éš±è— */
            width: 100%;
            height: 100%;
            flex-direction: row;
        }

        /* å·¦å´é‚Šæ¬„ */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .trip-info {
            padding: 0 20px 20px 20px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .trip-code {
            font-size: 0.9em;
            color: #666;
            background: #eee;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .day-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            overflow-y: auto;
        }

        .day-item {
            padding: 15px 20px;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .day-item:hover { background: #f8f9fa; }
        .day-item.active {
            background: #eef2ff;
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        /* å³å´å…§å®¹å€ */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #f4f7f6;
            position: relative;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* è¡Œç¨‹å¡ç‰‡ */
        .spot-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            align-items: center;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .time-badge {
            background: var(--bg);
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            color: #555;
            min-width: 60px;
            text-align: center;
        }

        .spot-info { flex: 1; }
        .spot-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 5px; }
        .spot-meta { font-size: 0.9em; color: #777; display: flex; gap: 10px; }
        
        .delete-btn {
            color: #ccc;
            cursor: pointer;
            padding: 8px;
        }
        .delete-btn:hover { color: var(--accent); }

        /* æ–°å¢æŒ‰éˆ• (å³ä¸‹è§’æ‡¸æµ®) */
        .fab-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(78, 84, 200, 0.4);
            cursor: pointer;
            border: none;
            transition: transform 0.2s;
        }
        .fab-btn:hover { transform: scale(1.1); }

        /* å½ˆè·³è¦–çª— (Modal) */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
        }
        
        .back-home {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9em;
            color: #888;
            cursor: pointer;
        }
        .back-home:hover { text-decoration: underline; }

        /* æ‰‹æ©Ÿ RWD */
        @media (max-width: 768px) {
            #planner-page { flex-direction: column; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px 0; }
            .trip-info { display: none; } /* æ‰‹æ©Ÿç‰ˆæš«æ™‚éš±è—æ¨™é¡Œï¼Œçœç©ºé–“ */
            .day-item { padding: 10px 15px; white-space: nowrap; border-left: none; border-bottom: 3px solid transparent; }
            .day-item.active { border-left: none; border-bottom-color: var(--primary); background: transparent; }
            .main-content { padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="landing-card" id="step-1">
            <h1 style="color:var(--primary)"><i class="fas fa-plane-departure"></i> æ—…ä¼´ Go!</h1>
            <p>è¼•é¬†è¦åŠƒï¼Œå³æ™‚åŒæ­¥</p>
            <div class="btn-group">
                <button class="big-btn btn-create" onclick="showCreateForm()">
                    <i class="fas fa-plus-circle"></i> æ–°å¢è¡Œç¨‹
                </button>
                <button class="big-btn btn-join" onclick="showJoinForm()">
                    <i class="fas fa-users"></i> åŠ å…¥è¡Œç¨‹
                </button>
            </div>
        </div>

        <div class="landing-card" id="step-create" style="display:none;">
            <h2>âœˆï¸ å»ºç«‹æ–°æ—…ç¨‹</h2>
            <input type="text" id="newTripName" placeholder="æ—…ç¨‹åç¨± (ä¾‹ï¼šæ±äº¬äº”æ—¥éŠ)">
            <label style="display:block; text-align:left; margin-top:10px; font-size:0.9em; color:#666;">å‡ºç™¼æ—¥æœŸ</label>
            <input type="date" id="newTripDate">
            <label style="display:block; text-align:left; margin-top:10px; font-size:0.9em; color:#666;">å¤©æ•¸</label>
            <input type="number" id="newTripDays" placeholder="ä¾‹å¦‚ï¼š5" min="1" max="30">
            
            <button class="big-btn btn-create" style="margin-top:20px; width:100%" onclick="createTrip()">é–‹å§‹è¦åŠƒ</button>
            <div class="back-home" onclick="resetLanding()">è¿”å›</div>
        </div>

        <div class="landing-card" id="step-join" style="display:none;">
            <h2>ğŸ”— åŠ å…¥ç¾æœ‰æ—…ç¨‹</h2>
            <p>è«‹è¼¸å…¥æœ‹å‹åˆ†äº«çµ¦æ‚¨çš„ 6 ä½æ•¸ä»£ç¢¼</p>
            <input type="text" id="joinCode" placeholder="ä¾‹å¦‚ï¼š123456" maxlength="6" style="text-align:center; letter-spacing: 5px; font-size: 1.5em;">
            <button class="big-btn btn-create" style="margin-top:20px; width:100%" onclick="joinTrip()">åŠ å…¥</button>
            <div class="back-home" onclick="resetLanding()">è¿”å›</div>
        </div>
    </div>

    <div id="planner-page">
        <div class="sidebar">
            <div class="trip-info">
                <h3 id="displayTripName" style="margin:0 0 5px 0;">è¼‰å…¥ä¸­...</h3>
                <span class="trip-code" onclick="copyCode()" title="é»æ“Šè¤‡è£½">
                    ä»£ç¢¼ï¼š<span id="displayTripCode">------</span> <i class="far fa-copy"></i>
                </span>
            </div>
            <ul class="day-list" id="dayList">
                </ul>
            <div style="padding:10px 20px; border-top:1px solid #eee;">
                <button onclick="logout()" style="width:100%; padding:8px; border:1px solid #ddd; background:white; color:#666; cursor:pointer; border-radius:5px;">é›¢é–‹è¡Œç¨‹</button>
            </div>
        </div>

        <div class="main-content">
            <div class="day-header">
                <h2 id="currentDayTitle">Day 1</h2>
                <span style="color:#666;" id="currentDateDisplay">2024/01/01</span>
            </div>
            
            <div id="itinerary-list">
                <p style="text-align:center; color:#999; margin-top:50px;">é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹æ™¯é»ï¼</p>
            </div>

            <button class="fab-btn" onclick="openAddItemModal()">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <div id="addItemModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“ æ–°å¢æ™¯é»</h3>
            <input type="time" id="itemTime">
            <input type="text" id="itemLocation" placeholder="æ™¯é»åç¨± (ä¾‹ï¼šé›·é–€)">
            <input type="text" id="itemNote" placeholder="å‚™è¨» (äº¤é€šæ–¹å¼ã€å¿…åƒç¾é£Ÿ...)">
            
            <div class="btn-group" style="flex-direction: row; margin-top: 20px;">
                <button class="big-btn" style="flex:1; background:#ddd; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="big-btn btn-create" style="flex:1;" onclick="addItem()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, doc, query, where, onSnapshot, orderBy, setDoc, serverTimestamp, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // æ‚¨çš„ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBYUTADnEjSDMd__T7n8xsoY5LFUn9qlDw",
            authDomain: "gogo-252ba.firebaseapp.com",
            projectId: "gogo-252ba",
            storageBucket: "gogo-252ba.firebasestorage.app",
            messagingSenderId: "599210924514",
            appId: "1:599210924514:web:15e78eb22c2b355e9b81bb",
            measurementId: "G-3VJRC7WZQB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // å…¨åŸŸè®Šæ•¸ï¼Œç”¨ä¾†è¨˜éŒ„ç¾åœ¨ä½¿ç”¨è€…æ­£åœ¨çœ‹å“ªå€‹è¡Œç¨‹ã€ç¬¬å¹¾å¤©
        let currentTripId = null;
        let currentTripData = null;
        let currentDayIndex = 1; // é è¨­ç¬¬ä¸€å¤©
        let unsubscribeItems = null; // ç”¨ä¾†å–æ¶ˆç›£è½

        // ç¶å®šå…¨åŸŸå‡½å¼çµ¦ HTML æŒ‰éˆ•å‘¼å«
        window.showCreateForm = () => switchStep('step-create');
        window.showJoinForm = () => switchStep('step-join');
        window.resetLanding = () => switchStep('step-1');
        window.openAddItemModal = () => document.getElementById('addItemModal').style.display = 'flex';
        window.closeModal = () => document.getElementById('addItemModal').style.display = 'none';
        
        // åˆ‡æ›æ­¡è¿é é¢çš„æ­¥é©Ÿ
        function switchStep(id) {
            ['step-1', 'step-create', 'step-join'].forEach(s => document.getElementById(s).style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        // ================= æ ¸å¿ƒåŠŸèƒ½ 1: å»ºç«‹æ–°è¡Œç¨‹ =================
        window.createTrip = async () => {
            const name = document.getElementById('newTripName').value;
            const date = document.getElementById('newTripDate').value;
            const days = parseInt(document.getElementById('newTripDays').value);

            if(!name || !date || !days) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šå–”ï¼"); return; }

            // ç”¢ç”Ÿéš¨æ©Ÿ 6 ä½æ•¸ä»£ç¢¼ (ç•¶ä½œ ID)
            const tripId = Math.floor(100000 + Math.random() * 900000).toString();

            try {
                // å¯«å…¥è³‡æ–™åº«
                await setDoc(doc(db, "trips", tripId), {
                    name: name,
                    startDate: date,
                    days: days,
                    createdAt: serverTimestamp()
                });
                
                loadTrip(tripId); // ç›´æ¥é€²å…¥è¡Œç¨‹
            } catch (e) {
                console.error(e);
                alert("å»ºç«‹å¤±æ•—ï¼š" + e.message);
            }
        };

        // ================= æ ¸å¿ƒåŠŸèƒ½ 2: åŠ å…¥è¡Œç¨‹ =================
        window.joinTrip = async () => {
            const code = document.getElementById('joinCode').value;
            if(code.length !== 6) { alert("è«‹è¼¸å…¥ 6 ä½æ•¸ä»£ç¢¼"); return; }

            const docRef = doc(db, "trips", code);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                loadTrip(code);
            } else {
                alert("æ‰¾ä¸åˆ°é€™å€‹è¡Œç¨‹ä»£ç¢¼ï¼Œè«‹ç¢ºèªæ˜¯å¦è¼¸å…¥æ­£ç¢ºï¼");
            }
        };

        // ================= æ ¸å¿ƒåŠŸèƒ½ 3: è¼‰å…¥ä¸¦é¡¯ç¤ºè¡Œç¨‹ä»‹é¢ =================
        async function loadTrip(tripId) {
            currentTripId = tripId;
            
            // 1. å–å¾—è¡Œç¨‹åŸºæœ¬è³‡æ–™
            const docRef = doc(db, "trips", tripId);
            const docSnap = await getDoc(docRef);
            currentTripData = docSnap.data();

            // 2. åˆ‡æ›ä»‹é¢
            document.getElementById('landing-page').style.transform = 'translateY(-100%)'; // æ»‘å‹•ç‰¹æ•ˆ
            setTimeout(() => { document.getElementById('landing-page').style.display = 'none'; }, 500);
            document.getElementById('planner-page').style.display = 'flex';

            // 3. æ›´æ–°å´é‚Šæ¬„è³‡è¨Š
            document.getElementById('displayTripName').innerText = currentTripData.name;
            document.getElementById('displayTripCode').innerText = tripId;

            // 4. ç”¢ç”Ÿå¤©æ•¸æŒ‰éˆ•
            renderSidebarDays();
            
            // 5. é è¨­è¼‰å…¥ç¬¬ä¸€å¤©
            selectDay(1);
        }

        // ç”¢ç”Ÿå´é‚Šæ¬„ (Day 1, Day 2...)
        function renderSidebarDays() {
            const list = document.getElementById('dayList');
            list.innerHTML = '';
            
            const start = new Date(currentTripData.startDate);

            for(let i=1; i<=currentTripData.days; i++) {
                // è¨ˆç®—æ—¥æœŸ
                let d = new Date(start);
                d.setDate(start.getDate() + (i-1));
                let dateStr = `${d.getMonth()+1}/${d.getDate()}`;

                let li = document.createElement('li');
                li.className = 'day-item';
                li.id = `day-btn-${i}`;
                li.innerHTML = `<span>Day ${i}</span> <span style="font-size:0.8em; color:#999;">${dateStr}</span>`;
                li.onclick = () => selectDay(i);
                list.appendChild(li);
            }
        }

        // é»é¸æŸä¸€å¤©
        window.selectDay = (dayIndex) => {
            currentDayIndex = dayIndex;

            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.day-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`day-btn-${dayIndex}`).classList.add('active');

            // æ›´æ–°æ¨™é¡Œ
            document.getElementById('currentDayTitle').innerText = `Day ${dayIndex}`;
            
            // è¨ˆç®—æ—¥æœŸé¡¯ç¤º
            const start = new Date(currentTripData.startDate);
            start.setDate(start.getDate() + (dayIndex-1));
            document.getElementById('currentDateDisplay').innerText = start.toLocaleDateString();

            // é–‹å§‹ç›£è½é€™ä¸€å¤©çš„æ–°å¢é …ç›®
            listenToItems();
        };

        // ================= æ ¸å¿ƒåŠŸèƒ½ 4: ç›£è½èˆ‡é¡¯ç¤ºç´°é … (å³æ™‚åŒæ­¥) =================
        function listenToItems() {
            // å¦‚æœä¹‹å‰æœ‰ç›£è½åˆ¥å¤©ï¼Œå…ˆå–æ¶ˆï¼Œé¿å…è³‡æºæµªè²»
            if(unsubscribeItems) unsubscribeItems();

            const q = query(
                collection(db, "items"), 
                where("tripId", "==", currentTripId),
                where("day", "==", currentDayIndex),
                orderBy("time")
            );

            unsubscribeItems = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('itinerary-list');
                list.innerHTML = '';

                if(snapshot.empty) {
                    list.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:50px; font-size:40px;"><i class="fas fa-map-marked-alt"></i></div><p style="text-align:center; color:#999;">é€™å¤©é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰å³ä¸‹è§’æ–°å¢ï¼</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const item = doc.data();
                    const el = document.createElement('div');
                    el.className = 'spot-card';
                    el.innerHTML = `
                        <div class="time-badge">${item.time}</div>
                        <div class="spot-info">
                            <div class="spot-title">${item.location}</div>
                            <div class="spot-meta"><i class="fas fa-sticky-note"></i> ${item.note || 'ç„¡å‚™è¨»'}</div>
                        </div>
                        <div class="delete-btn" onclick="deleteItem('${doc.id}')"><i class="fas fa-trash-alt"></i></div>
                    `;
                    list.appendChild(el);
                });
            });
        }

        // ================= æ ¸å¿ƒåŠŸèƒ½ 5: æ–°å¢èˆ‡åˆªé™¤ç´°é … =================
        window.addItem = async () => {
            const time = document.getElementById('itemTime').value;
            const loc = document.getElementById('itemLocation').value;
            const note = document.getElementById('itemNote').value;

            if(!time || !loc) { alert("è«‹è¼¸å…¥æ™‚é–“å’Œåœ°é»"); return; }

            try {
                await addDoc(collection(db, "items"), {
                    tripId: currentTripId,
                    day: currentDayIndex,
                    time: time,
                    location: loc,
                    note: note,
                    createdAt: serverTimestamp()
                });
                closeModal();
                // æ¸…ç©ºè¼¸å…¥æ¡†
                document.getElementById('itemLocation').value = '';
                document.getElementById('itemNote').value = '';
            } catch(e) {
                alert("æ–°å¢å¤±æ•—");
                console.error(e);
            }
        };

        window.deleteItem = async (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤é€™å€‹æ™¯é»å—ï¼Ÿ")) {
                await deleteDoc(doc(db, "items", id));
            }
        };

        // è¤‡è£½ä»£ç¢¼åŠŸèƒ½
        window.copyCode = () => {
            navigator.clipboard.writeText(currentTripId).then(() => alert("ä»£ç¢¼å·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹å§ï¼"));
        }

        // ç™»å‡º (é‡æ–°æ•´ç†é é¢æœ€å¿«)
        window.logout = () => location.reload();
        
        // å°‡ deleteItem æ›è¼‰åˆ° window (å› ç‚ºå®ƒæ˜¯å‹•æ…‹ç”Ÿæˆçš„ HTML éœ€è¦å‘¼å«)
        window.deleteItem = deleteItem;

    </script>
</body>
</html>
