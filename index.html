<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ä¼´ Go! V15.0 (åœ˜è³¼é–‹åœ˜ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4285F4; --bg: #f8f9fa; --card-bg: #ffffff; --text-main: #333; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: var(--text-main); overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        .app-container { display: flex; width: 100%; height: 100%; flex-direction: column; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 300px; background: white; border-right: 1px solid #eee; display: none; flex-direction: column; padding: 20px; }
        .sidebar-header { margin-bottom: 10px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .sidebar-btn { display: block; width: 100%; padding: 12px 15px; border: none; background: transparent; text-align: left; cursor: pointer; border-radius: 8px; font-size: 15px; color: #555; margin-bottom: 5px; transition: 0.2s; }
        .sidebar-btn:hover { background: #f1f3f4; }
        .sidebar-btn.active { background: #e8f0fe; color: var(--primary); font-weight: bold; }
        
        /* è²¡å‹™å ±è¡¨ */
        .cost-summary { margin-top: auto; padding: 15px; background: #fff8e1; border-radius: 12px; font-size: 0.9em; border: 1px solid #ffe0b2; }
        .cost-row { display: flex; justify-content: space-between; margin-bottom: 5px; color: #5d4037; }
        .cost-row.total { border-top: 1px dashed #d7ccc8; margin-top: 5px; padding-top: 5px; font-weight: bold; color: #d84315; }

        /* æ‰‹æ©Ÿå°èˆª */
        .mobile-header { background: white; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; }
        .header-left { display: flex; flex-direction: column; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .app-title { font-weight: bold; font-size: 1.2em; color: var(--primary); margin: 0; display:flex; align-items:center; gap:8px;}
        .trip-code { font-size: 0.8em; color: #666; background: #f1f3f4; padding: 4px 8px; border-radius: 12px; cursor: pointer; display: inline-block; margin-top: 4px;}
        
        .tool-icon { font-size: 1.1em; padding: 8px; cursor: pointer; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #f1f3f4; color: #555; }
        .tool-icon.logout { color: #d93025; background: #ffebee; }
        .tool-icon.money { color: #f57f17; background: #fff8e1; }

        .mobile-days-bar { display: flex; overflow-x: auto; background: white; padding: 10px 15px; border-bottom: 1px solid #eee; white-space: nowrap; gap: 10px; scrollbar-width: none; }
        .mobile-days-bar::-webkit-scrollbar { display: none; }
        .day-pill { display: inline-block; padding: 8px 16px; border-radius: 20px; background: #f1f3f4; color: #666; font-size: 0.9em; cursor: pointer; transition: 0.2s; flex-shrink: 0; text-align: center;}
        .day-pill small { display: block; font-size: 0.8em; opacity: 0.8; margin-top: -2px; }
        .day-pill.active { background: var(--primary); color: white; box-shadow: 0 2px 6px rgba(66,133,244,0.3); }

        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 120px; position: relative; }

        /* å¡ç‰‡ */
        .spot-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 0; display: flex; overflow: hidden; border: 1px solid #f0f0f0; position: relative; z-index: 2; cursor: pointer; transition: transform 0.1s;}
        .spot-card:active { transform: scale(0.98); } /* é»æ“Šå›é¥‹ */
        
        .time-col { width: 75px; background: #e8f0fe; color: #1967d2; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; font-weight: 700; font-size: 0.95em; text-align: center; border-right: 1px solid #dbeafe; }
        .info-col { flex: 1; padding: 15px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .spot-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 0.8em; padding: 3px 8px; border-radius: 6px; background: #f5f5f5; color: #666; display: flex; align-items: center; gap: 4px; }
        .badge.stay { background: #e0f2f1; color: #00695c; }
        .badge.cost { background: #fff8e1; color: #f57f17; border: 1px solid #ffe0b2; }
        
        /* äº¤é€šé€£æ¥å™¨ */
        .transport-connector { display: flex; align-items: center; justify-content: center; padding: 12px 0; position: relative; }
        .transport-connector::before { content: ''; position: absolute; top: 0; bottom: 0; left: 37px; width: 2px; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 6px, transparent 6px, transparent 12px); z-index: 0; }
        .transport-pill { background: white; border: 1px solid #eee; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; color: #666; position: relative; z-index: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 6px; }
        .transport-pill i { color: var(--primary); }

        .fab-btn { position: absolute; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 15px rgba(66,133,244,0.4); font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; z-index: 100; display:none; /* é è¨­éš±è—ï¼Œåªæœ‰ç·¨è¼¯è€…é¡¯ç¤º */ }
        .fab-btn:active { transform: scale(0.9); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; transition: opacity 0.3s; }
        .modal-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; transition: bottom 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); max-height: 90vh; overflow-y: auto; }
        .modal-active .modal-overlay { display: block; opacity: 1; }
        .modal-active .modal-sheet { bottom: 0; }

        #mapPreview { width: 100%; height: 150px; background: #eee; border-radius: 10px; margin-top: 10px; margin-bottom: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.9em; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9em; font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #fff; appearance: none; }
        input:disabled, select:disabled { background: #f5f5f5; color: #999; border-color: #eee; } /* V15.0: é–å®šæ¨£å¼ */
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .btn-full { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-cancel { background: #f1f3f4; color: #333; margin-top: 10px; }
        .btn-map { background: #e8f0fe; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;}
        .btn-del { background: #ffebee; color: #d32f2f; margin-top: 30px; } /* åˆªé™¤æŒ‰éˆ•ç¨ç«‹ */

        /* åˆ†å¸³åŠŸèƒ½å€å¡Š */
        .split-bill-box { background: #fff8e1; padding: 15px; border-radius: 12px; border: 1px solid #ffe0b2; margin-bottom: 15px; }
        .split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .split-name { font-weight: bold; color: #5d4037; }
        .split-input { width: 60px; padding: 5px; text-align: center; border: 1px solid #d7ccc8; border-radius: 5px; background: white; font-weight: bold;}
        
        .role-badge { font-size: 0.6em; padding: 2px 6px; border-radius: 4px; vertical-align: middle; white-space: nowrap;}
        .role-editor { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .role-viewer { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        /* æ­¡è¿é  */
        #landing { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        .landing-options { width: 100%; max-width: 300px; }
        .landing-form { display: none; width: 100%; max-width: 300px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .landing-input { width: 100%; padding: 15px; font-size: 18px; text-align: center; border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px; }

        @media (min-width: 769px) {
            .app-container { flex-direction: row; }
            .sidebar { display: flex; }
            .mobile-header, .mobile-days-bar { display: none; }
            .modal-sheet { width: 450px; left: 50%; top: 50%; bottom: auto !important; transform: translate(-50%, -50%) scale(0.95); border-radius: 16px; opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; }
            .modal-active .modal-sheet { opacity: 1; pointer-events: auto; bottom: auto !important; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>

    <div id="landing">
        <h1 style="color:var(--primary); font-size: 2.5em; margin-bottom: 10px;">æ—…ä¼´ Go!</h1>
        <p style="color:#888; margin-bottom: 40px;">è¡Œç¨‹è¦åŠƒãƒ»åœ˜è³¼åˆ†å¸³</p>
        <div id="landingOptions" class="landing-options">
            <button class="btn-full btn-primary" onclick="showLandingForm('login')">è¼‰å…¥è¡Œç¨‹</button>
            <button class="btn-full btn-cancel" onclick="showLandingForm('create')">é–‹æ–°åœ˜/å»ºç«‹è¡Œç¨‹</button>
        </div>
        <div id="landingLogin" class="landing-form">
            <input type="text" id="codeEnter" class="landing-input" placeholder="è¡Œç¨‹ä»£ç¢¼">
            <input type="password" id="passEnter" class="landing-input" placeholder="å¯†ç¢¼ (æª¢è¦–è€…å…å¡«)">
            <button class="btn-full btn-primary" onclick="loadByCode()">è¼‰å…¥</button>
            <button class="btn-full btn-cancel" onclick="resetLanding()">è¿”å›</button>
        </div>
        <div id="landingCreate" class="landing-form">
            <input type="text" id="newTripName" class="landing-input" placeholder="æ—…ç¨‹åç¨±" style="text-align:left;">
            <div class="form-group" style="text-align:left;">
                <label>åƒèˆ‡å®¶åº­/æˆå“¡ (é€—è™Ÿåˆ†éš”)</label>
                <input type="text" id="newTripGroups" placeholder="ä¾‹å¦‚ï¼šé™³å®¶, æ—å®¶, ç‹å®¶" value="é™³å®¶, æ—å®¶">
            </div>
            <div class="form-group" style="text-align:left;"><label>ç·¨è¼¯å¯†ç¢¼ (å¿…å¡«)</label><input type="text" id="newTripPass" placeholder="è¨­å®šå¯†ç¢¼"></div>
            <div class="row form-group" style="text-align:left;">
                <div class="col"><label>å‡ºç™¼</label><input type="date" id="newTripDate"></div>
                <div class="col"><label>å¤©æ•¸</label><input type="number" id="newTripDays" value="5"></div>
            </div>
            <button class="btn-full btn-primary" onclick="createNewTrip()">å»ºç«‹</button>
            <button class="btn-full btn-cancel" onclick="resetLanding()">è¿”å›</button>
        </div>
    </div>

    <div class="app-container" id="app" style="display:none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:8px;">
                    <h2 id="pcTripTitle" style="margin:0;">...</h2>
                    <span id="pcRoleBadge" class="role-badge"></span>
                </div>
                <small id="pcTripCode" style="color:#666; display:block; margin-top:5px; cursor:pointer;" onclick="copyCode()">ä»£ç¢¼: --- <i class="far fa-copy"></i></small>
            </div>
            <div id="pcDayList" class="day-list" style="flex:1;"></div>
            <div id="pcCostSummary" class="cost-summary"></div>
            <button class="btn-full btn-cancel" style="margin-top:10px;" onclick="logout()">é€€å‡º</button>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; height:100%;">
            <div class="mobile-header">
                <div class="header-left">
                    <div class="app-title"><span id="mobileTripTitle">è¡Œç¨‹</span><span id="mobileRoleBadge" class="role-badge"></span></div>
                    <span class="trip-code" id="mobileCode" onclick="copyCode()">ä»£ç¢¼: ---</span>
                </div>
                <div class="header-right">
                    <div class="tool-icon money" onclick="showMoneyModal()" title="å¸³æœ¬"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="tool-icon logout" onclick="logout()" title="é€€å‡º"><i class="fas fa-sign-out-alt"></i></div>
                </div>
            </div>

            <div class="mobile-days-bar" id="mobileDayList"></div>
            <div class="main-content" id="listArea"></div>
            <button id="fabBtn" class="fab-btn" onclick="openItemModal()"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>
    <div id="itemModalSheet" class="modal-sheet">
        <h3 id="modalTitle" style="margin-top:0; color:var(--primary);">ğŸ“ è©³ç´°å…§å®¹</h3>
        <input type="hidden" id="editId">
        <button class="btn-full btn-map" id="routeBtn" onclick="openGoogleMapsRoute()" style="display:none;"><i class="fas fa-map-marked-alt"></i> é–‹å•Ÿ Google Maps å°èˆª</button>
        
        <div class="form-group"><label>åœ°é» / é …ç›®åç¨±</label><input type="text" id="locInput" placeholder="ä¾‹å¦‚ï¼šè¿ªå£«å°¼é–€ç¥¨" onblur="updateMapPreview(this.value)"></div>
        <div id="mapPreview">åœ°åœ–é è¦½å€</div>
        <div class="row form-group">
            <div class="col"><label>æ™‚é–“</label><input type="time" id="timeInput"></div>
            <div class="col"><label>åœç•™(åˆ†)</label><input type="number" id="durationInput" placeholder="60"></div>
        </div>
        <div class="form-group">
            <label>äº¤é€š</label>
            <div class="row">
                <div class="col" style="flex:2;"><select id="transportInput"><option value="ç„¡">ç„¡</option><option value="é–‹è»Š">ğŸš— é–‹è»Š</option><option value="å¤§çœ¾é‹è¼¸">ğŸš† å¤§çœ¾é‹è¼¸</option><option value="æ­¥è¡Œ">ğŸš¶ æ­¥è¡Œ</option></select></div>
                <div class="col" style="flex:1;"><input type="number" id="travelTimeInput" placeholder="åˆ†"></div>
            </div>
        </div>
        
        <div class="split-bill-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label style="margin:0;"><i class="fas fa-shopping-cart"></i> åœ˜è³¼/è¨˜å¸³æ¸…å–®</label>
                <small id="totalPriceDisplay" style="color:#d84315; font-weight:bold;">ç¸½è¨ˆ: $0</small>
            </div>
            <div class="form-group">
                <input type="number" id="unitPriceInput" placeholder="è¼¸å…¥å–®åƒ¹ (0å‰‡ä¸è¨˜å¸³)" oninput="calcTotal()">
            </div>
            <div id="familySplitList">
                </div>
        </div>

        <div class="form-group"><label>å‚™è¨»</label><input type="text" id="noteInput" placeholder="å‚™è¨»..."></div>
        
        <button id="btnSave" class="btn-full btn-primary" onclick="saveItem()">å„²å­˜ä¿®æ”¹</button>
        <button id="btnDel" class="btn-full btn-del" onclick="delItem()" style="display:none;">åˆªé™¤æ­¤è¡Œç¨‹</button>
        <button class="btn-full btn-cancel" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>

    <div id="moneyModalSheet" class="modal-sheet">
        <h3 style="margin-top:0; color:#f57f17;"><i class="fas fa-file-invoice-dollar"></i> æ—…ç¨‹ç¸½å¸³æœ¬</h3>
        <div id="mobileCostSummary" class="cost-summary" style="background:white; border:none; padding:0;"></div>
        <button class="btn-full btn-cancel" onclick="closeAllModals()">é—œé–‰</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, doc, query, where, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYUTADnEjSDMd__T7n8xsoY5LFUn9qlDw",
            authDomain: "gogo-252ba.firebaseapp.com",
            projectId: "gogo-252ba",
            storageBucket: "gogo-252ba.firebasestorage.app",
            messagingSenderId: "599210924514",
            appId: "1:599210924514:web:15e78eb22c2b355e9b81bb",
            measurementId: "G-3VJRC7WZQB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentTripId = localStorage.getItem('lastTripId');
        let currentPass = localStorage.getItem('lastTripPass');
        let currentDay = 1;
        let unsubscribe = null;
        let currentData = [];
        let tripData = null;
        let isEditor = false;

        if(currentTripId) {
            document.getElementById('codeEnter').value = currentTripId;
            if(currentPass) document.getElementById('passEnter').value = currentPass;
            tryLogin(currentTripId, currentPass, true);
        }

        async function tryLogin(code, password, isAuto = false) {
            try {
                const snap = await getDoc(doc(db, "trips", code));
                if(snap.exists()) {
                    tripData = snap.data();
                    if (password && tripData.password && password === tripData.password) {
                        isEditor = true; localStorage.setItem('lastTripPass', password);
                    } else {
                        isEditor = false;
                        if(password) { if(!isAuto) alert("å¯†ç¢¼éŒ¯èª¤ï¼Œä»¥æª¢è¦–æ¨¡å¼è¼‰å…¥"); localStorage.removeItem('lastTripPass'); }
                    }
                    currentTripId = code; localStorage.setItem('lastTripId', code);
                    initApp();
                } else {
                    if(!isAuto) alert("æ‰¾ä¸åˆ°æ­¤è¡Œç¨‹");
                    localStorage.removeItem('lastTripId');
                }
            } catch (e) {
                console.error(e);
                if(!isAuto) alert("é€£ç·šéŒ¯èª¤");
            }
        }

        window.showLandingForm = (type) => {
            document.getElementById('landingOptions').style.display = 'none';
            if(type === 'login') document.getElementById('landingLogin').style.display = 'block';
            else document.getElementById('landingCreate').style.display = 'block';
        }
        window.resetLanding = () => {
            document.getElementById('landingOptions').style.display = 'block';
            document.getElementById('landingLogin').style.display = 'none';
            document.getElementById('landingCreate').style.display = 'none';
        }
        window.loadByCode = () => {
            const code = document.getElementById('codeEnter').value.trim();
            const pass = document.getElementById('passEnter').value.trim();
            if(!code) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
            tryLogin(code, pass);
        }
        window.createNewTrip = async () => {
            const name = document.getElementById('newTripName').value;
            const pass = document.getElementById('newTripPass').value.trim();
            const date = document.getElementById('newTripDate').value;
            const days = document.getElementById('newTripDays').value;
            const groupsStr = document.getElementById('newTripGroups').value;
            if(!name || !days || !pass || !groupsStr) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");
            const groups = groupsStr.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            const id = Math.floor(100000 + Math.random()*900000).toString();
            try {
                const newTrip = { name, password: pass, startDate: date, days: parseInt(days), groups, createdAt: serverTimestamp() };
                await setDoc(doc(db, "trips", id), newTrip);
                currentTripId = id; isEditor = true; tripData = newTrip;
                localStorage.setItem('lastTripId', id); localStorage.setItem('lastTripPass', pass);
                initApp();
            } catch(e) { alert("å»ºç«‹å¤±æ•—ï¼š" + e.message); }
        }

        function initApp() {
            document.getElementById('landing').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            document.getElementById('mobileTripTitle').innerText = tripData.name;
            document.getElementById('pcTripTitle').innerText = tripData.name;
            document.getElementById('mobileCode').innerText = `ä»£ç¢¼: ${currentTripId}`;
            document.getElementById('pcTripCode').innerHTML = `ä»£ç¢¼: ${currentTripId} <i class="far fa-copy"></i>`;

            const mBadge = document.getElementById('mobileRoleBadge');
            const pcBadge = document.getElementById('pcRoleBadge');
            const fab = document.getElementById('fabBtn');
            
            if(isEditor) {
                mBadge.innerText = "ç·¨è¼¯è€… (åœ˜é•·)"; mBadge.className = "role-badge role-editor"; pcBadge.innerText = mBadge.innerText; pcBadge.className = mBadge.className;
                fab.style.display = "flex"; // åªæœ‰åœ˜é•·èƒ½é–‹åœ˜
            } else {
                mBadge.innerText = "æª¢è¦–è€… (åœ˜å“¡)"; mBadge.className = "role-badge role-viewer"; pcBadge.innerText = mBadge.innerText; pcBadge.className = mBadge.className;
                fab.style.display = "none";
            }

            renderDayNav(tripData.days);
            changeDay(1);
            listenAllCosts(); 
        }

        function listenAllCosts() {
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            onSnapshot(q, (snapshot) => {
                let summary = {}; let grandTotal = 0;
                if(tripData.groups) tripData.groups.forEach(g => summary[g] = 0);
                snapshot.forEach(doc => {
                    const item = doc.data();
                    if(item.splitData) {
                        for(let family in item.splitData) {
                            const cost = item.splitData[family].cost || 0;
                            if(summary[family] !== undefined) summary[family] += cost;
                            grandTotal += cost;
                        }
                    }
                });
                let html = "";
                for(let family in summary) html += `<div class="cost-row"><span class="split-name">${family}</span><span>$${summary[family].toLocaleString()}</span></div>`;
                html += `<div class="cost-row total"><span>ç¸½æ”¯å‡º</span><span>$${grandTotal.toLocaleString()}</span></div>`;
                document.getElementById('pcCostSummary').innerHTML = html;
                document.getElementById('mobileCostSummary').innerHTML = html;
            });
        }

        function getDayLabel(dayIndex) {
            if (!tripData.startDate) return `Day ${dayIndex}`;
            const targetDate = new Date(tripData.startDate);
            targetDate.setDate(targetDate.getDate() + (dayIndex - 1));
            const month = targetDate.getMonth() + 1; const date = targetDate.getDate();
            const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][targetDate.getDay()];
            return `Day ${dayIndex} <small>${month}/${date} (${week})</small>`;
        }

        function renderDayNav(totalDays) {
            const pcList = document.getElementById('pcDayList');
            const mobileList = document.getElementById('mobileDayList');
            pcList.innerHTML = ''; mobileList.innerHTML = '';
            for(let i=1; i<=totalDays; i++) {
                const label = getDayLabel(i);
                const pcBtn = document.createElement('button');
                pcBtn.id = `pc-day-${i}`; pcBtn.className = 'sidebar-btn';
                pcBtn.innerHTML = `Day ${i} <span class="sidebar-date">${label.split('<small>')[1].replace('</small>','')}</span>`;
                pcBtn.onclick = () => changeDay(i);
                pcList.appendChild(pcBtn);
                const mBtn = document.createElement('div');
                mBtn.id = `mobile-day-${i}`; mBtn.className = 'day-pill';
                mBtn.innerHTML = label;
                mBtn.onclick = () => changeDay(i);
                mobileList.appendChild(mBtn);
            }
        }

        window.changeDay = (d) => {
            currentDay = d;
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.day-pill').forEach(b => b.classList.remove('active'));
            const pcBtn = document.getElementById(`pc-day-${d}`);
            const mobileBtn = document.getElementById(`mobile-day-${d}`);
            if(pcBtn) pcBtn.classList.add('active');
            if(mobileBtn) { mobileBtn.classList.add('active'); mobileBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }
            listenData();
        }

        function formatDuration(m) {
            if(!m) return "";
            const h = Math.floor(m / 60); const min = m % 60;
            return h > 0 ? `${h}æ™‚${min}åˆ†` : `${min}åˆ†é˜`;
        }

        function listenData() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            unsubscribe = onSnapshot(q, (snapshot) => {
                const listDiv = document.getElementById('listArea');
                listDiv.innerHTML = "";
                currentData = [];
                snapshot.forEach(doc => { const data = doc.data(); if(data.day == currentDay) currentData.push({ id: doc.id, ...data }); });
                currentData.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));

                if(currentData.length === 0) { listDiv.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:50px;'><i class='fas fa-map-signs' style='font-size:3em;opacity:0.3;'></i><br><br>é€™è£¡é‚„æ²’æœ‰è¡Œç¨‹</div>"; return; }

                currentData.forEach((item, index) => {
                    if (index > 0 && item.transport && item.transport !== 'ç„¡') {
                        let icon = 'fas fa-arrow-down';
                        if(item.transport.includes('é–‹è»Š')) icon = 'fas fa-car';
                        let timeHtml = item.travelDuration ? `<span>â±ï¸ ${formatDuration(item.travelDuration)}</span>` : '';
                        listDiv.innerHTML += `<div class="transport-connector"><div class="transport-pill"><i class="${icon}"></i> ${item.transport} ${timeHtml}</div></div>`;
                    }
                    const stayHtml = item.duration ? `<span class="badge stay"><i class="far fa-clock"></i> åœ ${formatDuration(item.duration)}</span>` : '';
                    let costHtml = item.totalCost > 0 ? `<span class="badge cost"><i class="fas fa-shopping-cart"></i> åœ˜è³¼ $${item.totalCost.toLocaleString()}</span>` : '';
                    
                    // V15.0: é»æ“Šå¡ç‰‡é–‹å•Ÿç·¨è¼¯ (æª¢è¦–è€…ä¹Ÿå¯ä»¥é»)
                    listDiv.innerHTML += `
                        <div class="spot-card" onclick="openItemModal('${item.id}')">
                            <div class="time-col"><div>${item.time || "--:--"}</div></div>
                            <div class="info-col"><div class="spot-title">${item.location}</div><div class="badges">${stayHtml}${costHtml}</div></div>
                            <div class="actions-col" style="justify-content:center; align-items:center; color:#ccc;">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>`;
                });
            });
        }

        window.closeAllModals = () => {
            document.body.classList.remove('modal-active');
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('itemModalSheet').style.bottom = '-100%';
            document.getElementById('moneyModalSheet').style.bottom = '-100%';
        }

        window.showMoneyModal = () => {
            document.body.classList.add('modal-active');
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('moneyModalSheet').style.bottom = '0';
        }

        window.openItemModal = (id = null) => {
            document.body.classList.add('modal-active');
            document.getElementById('modalOverlay').style.display = 'block';
            const sheet = document.getElementById('itemModalSheet');
            if(window.innerWidth >= 769) { sheet.style.opacity = '1'; sheet.style.pointerEvents = 'auto'; } else { sheet.style.bottom = '0'; }

            document.getElementById('editId').value = id || "";
            const routeBtn = document.getElementById('routeBtn');
            window.updateMapPreview('');

            // V15.0: æ¬Šé™æ§åˆ¶ - é–å®šæ¬„ä½
            const lockFields = !isEditor; // å¦‚æœä¸æ˜¯ç·¨è¼¯è€…ï¼Œå°±é–å®š
            ['locInput','timeInput','durationInput','transportInput','travelTimeInput','unitPriceInput','noteInput'].forEach(fid => {
                document.getElementById(fid).disabled = lockFields;
            });
            document.getElementById('btnDel').style.display = isEditor ? 'block' : 'none'; // åªæœ‰ç·¨è¼¯è€…èƒ½åˆª
            document.getElementById('modalTitle').innerText = isEditor ? "ğŸ“ ç·¨è¼¯è¡Œç¨‹ (åœ˜é•·)" : "ğŸ›’ åœ˜è³¼ç™»è¨˜ (åœ˜å“¡)";

            // ç”Ÿæˆå®¶åº­åˆ—è¡¨ (æ°¸é å•Ÿç”¨)
            const splitList = document.getElementById('familySplitList');
            splitList.innerHTML = '';
            if(tripData.groups) {
                tripData.groups.forEach(family => {
                    splitList.innerHTML += `
                        <div class="split-row">
                            <span class="split-name">${family}</span>
                            <div><input type="number" class="split-input" id="qty-${family}" placeholder="0" oninput="calcTotal()"><small>å€‹</small></div>
                        </div>`;
                });
            }

            if(id) {
                const item = currentData.find(x => x.id === id);
                document.getElementById('locInput').value = item.location;
                document.getElementById('timeInput').value = item.time;
                document.getElementById('durationInput').value = item.duration || "";
                document.getElementById('transportInput').value = item.transport || "ç„¡";
                document.getElementById('travelTimeInput').value = item.travelDuration || "";
                document.getElementById('noteInput').value = item.note || "";
                document.getElementById('unitPriceInput').value = item.unitPrice || "";
                if(item.splitData) {
                    for(let family in item.splitData) {
                        const input = document.getElementById(`qty-${family}`);
                        if(input) input.value = item.splitData[family].qty;
                    }
                    calcTotal();
                }
                routeBtn.style.display = 'none';
                window.updateMapPreview(item.location);
            } else {
                ['locInput','timeInput','durationInput','noteInput','travelTimeInput','unitPriceInput'].forEach(i => document.getElementById(i).value = '');
                document.getElementById('transportInput').value = "ç„¡";
                document.querySelectorAll('.split-input').forEach(i => i.value = '');
                calcTotal();
                routeBtn.style.display = 'none';
            }
        }

        window.calcTotal = () => {
            const price = parseFloat(document.getElementById('unitPriceInput').value) || 0;
            let total = 0;
            document.querySelectorAll('.split-input').forEach(input => {
                const qty = parseFloat(input.value) || 0;
                total += qty * price;
            });
            document.getElementById('totalPriceDisplay').innerText = `ç¸½è¨ˆ: $${total.toLocaleString()}`;
        }

        window.updateMapPreview = (loc) => { const mapDiv = document.getElementById('mapPreview'); if(!loc) { mapDiv.innerHTML = "åœ°åœ–é è¦½å€"; return; } mapDiv.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://www.google.com/maps?q=${encodeURIComponent(loc)}&output=embed"></iframe>`; }
        window.openGoogleMapsRoute = () => { const current = document.getElementById('locInput').value; let url = `https://www.google.com/maps?q=${encodeURIComponent(window.lastLoc)}`; if(current) url += `&destination=${encodeURIComponent(current)}`; window.open(url, '_blank'); }

        window.saveItem = async () => {
            const id = document.getElementById('editId').value;
            const unitPrice = parseFloat(document.getElementById('unitPriceInput').value) || 0;
            let splitData = {}; let totalCost = 0;
            
            if(unitPrice > 0 && tripData.groups) {
                tripData.groups.forEach(family => {
                    const qty = parseFloat(document.getElementById(`qty-${family}`).value) || 0;
                    if(qty > 0) { splitData[family] = { qty: qty, cost: qty * unitPrice }; totalCost += qty * unitPrice; }
                });
            }

            try { 
                if(id) {
                    if(!isEditor) {
                        // V15.0: æª¢è¦–è€…åªèƒ½æ›´æ–°åˆ†å¸³è³‡è¨Š (Partial Update)
                        await updateDoc(doc(db, "items", id), { splitData, totalCost });
                    } else {
                        // ç·¨è¼¯è€…æ›´æ–°å…¨éƒ¨
                        const data = {
                            location: document.getElementById('locInput').value,
                            time: document.getElementById('timeInput').value,
                            duration: document.getElementById('durationInput').value,
                            transport: document.getElementById('transportInput').value,
                            travelDuration: document.getElementById('travelTimeInput').value,
                            note: document.getElementById('noteInput').value,
                            unitPrice, splitData, totalCost
                        };
                        await updateDoc(doc(db, "items", id), data);
                    }
                } else {
                    if(!isEditor) return alert("åªæœ‰åœ˜é•·å¯ä»¥é–‹æ–°åœ˜/æ–°å¢è¡Œç¨‹");
                    const data = {
                        tripId: currentTripId, day: parseInt(currentDay),
                        location: document.getElementById('locInput').value,
                        time: document.getElementById('timeInput').value,
                        duration: document.getElementById('durationInput').value,
                        transport: document.getElementById('transportInput').value,
                        travelDuration: document.getElementById('travelTimeInput').value,
                        note: document.getElementById('noteInput').value,
                        unitPrice, splitData, totalCost,
                        createdAt: serverTimestamp()
                    };
                    await addDoc(collection(db, "items"), data);
                }
                closeAllModals(); 
            } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
        }

        window.delItem = async () => { 
            const id = document.getElementById('editId').value;
            if(!isEditor) return; 
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹/åœ˜è³¼ï¼Ÿ")) {
                await deleteDoc(doc(db, "items", id)); 
                closeAllModals();
            }
        }
        window.logout = () => { localStorage.clear(); location.reload(); }
        window.copyCode = () => { navigator.clipboard.writeText(currentTripId).then(()=>alert("ä»£ç¢¼å·²è¤‡è£½")); }
        
        window.changeDay = changeDay; window.openItemModal = openItemModal; window.closeAllModals = closeAllModals; window.saveItem = saveItem; window.delItem = delItem; window.openGoogleMapsRoute = openGoogleMapsRoute; window.loadByCode = loadByCode; window.showLandingForm = showLandingForm; window.resetLanding = resetLanding; window.createNewTrip = createNewTrip; window.logout = logout; window.copyCode = copyCode; window.updateMapPreview = updateMapPreview; window.calcTotal = calcTotal; window.showMoneyModal = showMoneyModal;
    </script>
</body>
</html>
