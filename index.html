<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ä¼´ Go! V8.0 (çµæ§‹é‡æ§‹ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºç¤è¨­å®š */
        body { font-family: 'Noto Sans TC', sans-serif; background: #f0f2f5; margin: 0; display: flex; height: 100vh; color: #333; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .day-list { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; }
        .day-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .day-item.active { background: #e8f0fe; color: #1a73e8; font-weight: bold; }
        
        /* ä¸»å…§å®¹å€ */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; }
        .top-bar { padding: 15px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        
        /* åˆ—è¡¨å€ (é—œéµä¿®æ­£ï¼šå¼·åˆ¶è¨­å®šèƒŒæ™¯è‰²èˆ‡é«˜åº¦) */
        #itinerary-list { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            background-color: #f8f9fa; /* ç¢ºä¿èƒŒæ™¯æœ‰é¡è‰² */
        }

        /* V8.0 å¡ç‰‡æ¨£å¼ (å¼·åˆ¶é¡¯è‰²æ¨¡å¼) */
        .spot-card {
            background: white;
            border: 1px solid #ddd; /* åŠ ä¸Šé‚Šæ¡† */
            border-left: 5px solid #4285F4; /* å·¦å´è—æ¢ */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; /* ç¢ºä¿å…§å®¹æ’é–‹ */
            min-height: 50px; /* é˜²æ­¢é«˜åº¦å´©å¡Œ */
        }

        .info-area { flex: 1; }
        .action-area { display: flex; flex-direction: column; justify-content: center; border-left: 1px solid #eee; padding-left: 10px; }

        /* é™¤éŒ¯å€å¡Š */
        #debug-area {
            background: #333; color: #0f0; padding: 10px; font-size: 12px; font-family: monospace;
            max-height: 100px; overflow-y: auto; margin: 10px; border-radius: 5px;
        }

        /* æŒ‰éˆ•èˆ‡å½ˆçª— */
        .fab-btn { position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: #4285F4; color: white; border: none; font-size: 30px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 300px; }
        input, select { width: 100%; padding: 8px; margin: 5px 0 10px 0; box-sizing: border-box; }
        .btn { padding: 10px; width: 100%; cursor: pointer; border: none; border-radius: 5px; margin-top: 5px; }
        .btn-primary { background: #4285F4; color: white; }
        .btn-outline { background: #eee; color: #333; }
        
        /* æ­¡è¿é  */
        #landing { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <div id="landing">
        <h1>âœˆï¸ æ—…ä¼´ Go! V8.0</h1>
        <p>çµæ§‹é‡æ§‹ç‰ˆ - çµ•å°é¡¯ç¤º</p>
        <div style="width: 250px;">
            <input type="text" id="joinCode" placeholder="è¼¸å…¥è¡Œç¨‹ä»£ç¢¼" style="text-align: center; font-size: 18px;">
            <button class="btn btn-primary" onclick="loadUserTrip()">è¼‰å…¥è¡Œç¨‹</button>
            <button class="btn btn-outline" onclick="createTrip()">å»ºç«‹æ–°è¡Œç¨‹</button>
        </div>
    </div>

    <div class="sidebar">
        <div style="padding: 20px; border-bottom: 1px solid #ddd;">
            <h3 id="tripName" style="margin:0;">è¼‰å…¥ä¸­...</h3>
            <small id="tripCode">ä»£ç¢¼: ---</small>
        </div>
        <ul class="day-list" id="dayList"></ul>
        <div id="debug-area">ç­‰å¾…è³‡æ–™...</div>
    </div>

    <div class="main">
        <div class="top-bar">
            <h2 id="dayTitle" style="margin:0;">Day 1</h2>
        </div>
        
        <div id="itinerary-list">
            </div>

        <button class="fab-btn" onclick="openModal()">+</button>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢/ä¿®æ”¹è¡Œç¨‹</h3>
            <input type="hidden" id="editId">
            <input type="text" id="inLoc" placeholder="åœ°é»">
            <input type="time" id="inTime">
            <input type="text" id="inNote" placeholder="å‚™è¨»">
            <button class="btn btn-primary" onclick="saveData()">å„²å­˜</button>
            <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, doc, query, where, onSnapshot, setDoc, serverTimestamp, deleteDoc, updateDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYUTADnEjSDMd__T7n8xsoY5LFUn9qlDw",
            authDomain: "gogo-252ba.firebaseapp.com",
            projectId: "gogo-252ba",
            storageBucket: "gogo-252ba.firebasestorage.app",
            messagingSenderId: "599210924514",
            appId: "1:599210924514:web:15e78eb22c2b355e9b81bb",
            measurementId: "G-3VJRC7WZQB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentTripId = localStorage.getItem('lastTripId');
        let currentDay = 1;
        let unsubscribe = null;
        let dayItems = [];

        // è‡ªå‹•ç™»å…¥
        if(currentTripId) {
            document.getElementById('joinCode').value = currentTripId;
        }

        window.loadUserTrip = async () => {
            const code = document.getElementById('joinCode').value;
            if(!code) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
            
            const snap = await getDoc(doc(db, "trips", code));
            if(snap.exists()) {
                currentTripId = code;
                localStorage.setItem('lastTripId', code);
                initApp(snap.data());
            } else {
                alert("æ‰¾ä¸åˆ°è¡Œç¨‹");
            }
        };

        window.createTrip = async () => {
            const id = Math.floor(100000 + Math.random() * 900000).toString();
            await setDoc(doc(db, "trips", id), { name: "æ–°æ—…ç¨‹", days: 5 });
            currentTripId = id;
            localStorage.setItem('lastTripId', id);
            initApp({ name: "æ–°æ—…ç¨‹", days: 5 });
        };

        function initApp(data) {
            document.getElementById('landing').style.display = 'none';
            document.getElementById('tripName').innerText = data.name;
            document.getElementById('tripCode').innerText = "ä»£ç¢¼: " + currentTripId;
            
            const list = document.getElementById('dayList');
            list.innerHTML = "";
            for(let i=1; i<=data.days; i++) {
                const li = document.createElement('li');
                li.className = `day-item ${i===1?'active':''}`;
                li.innerText = `Day ${i}`;
                li.onclick = () => changeDay(i, li);
                list.appendChild(li);
            }
            startListen();
        }

        function changeDay(d, el) {
            currentDay = d;
            document.getElementById('dayTitle').innerText = `Day ${d}`;
            document.querySelectorAll('.day-item').forEach(x => x.classList.remove('active'));
            el.classList.add('active');
            startListen();
        }

        function debug(msg) {
            const box = document.getElementById('debug-area');
            box.innerHTML += `<div>> ${msg}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        // V8.0 æ ¸å¿ƒï¼šä¸æ‹¼æ¥å­—ä¸²ï¼Œæ”¹ç”¨ DOM æ“ä½œ
        function startListen() {
            if(unsubscribe) unsubscribe();
            debug(`é–‹å§‹ç›£è½ Day ${currentDay}...`);
            
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const container = document.getElementById('itinerary-list');
                container.innerHTML = ""; // æ¸…ç©º
                dayItems = [];

                debug(`æ”¶åˆ°è³‡æ–™åº«å›å‚³: ${snapshot.size} ç­†`);

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.day == currentDay) {
                        dayItems.push({ id: doc.id, ...data });
                    }
                });

                debug(`æœ¬é æœ‰æ•ˆè³‡æ–™: ${dayItems.length} ç­†`);

                // æ’åº
                dayItems.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));

                if(dayItems.length === 0) {
                    container.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>ğŸ“­ é€™è£¡æ²’æœ‰è¡Œç¨‹</div>";
                }

                // === V8.0 é‡é»ï¼šç”¨ createElement å»ºç«‹å¡ç‰‡ ===
                dayItems.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'spot-card';
                    
                    // å…§å®¹å€
                    const info = document.createElement('div');
                    info.className = 'info-area';
                    info.innerHTML = `
                        <div style="font-weight:bold; font-size:1.1em;">${item.location || "æœªå‘½å"}</div>
                        <div style="color:#4285F4; margin:5px 0;">ğŸ•’ ${item.time || "--:--"}</div>
                        <div style="color:#666; font-size:0.9em;">ğŸ“ ${item.note || "ç„¡å‚™è¨»"}</div>
                    `;

                    // æŒ‰éˆ•å€
                    const actions = document.createElement('div');
                    actions.className = 'action-area';
                    
                    const btnEdit = document.createElement('button');
                    btnEdit.innerHTML = '<i class="fas fa-pen"></i>';
                    btnEdit.style.marginBottom = "10px";
                    btnEdit.style.cursor = "pointer";
                    btnEdit.onclick = () => openModal(item.id);

                    const btnDel = document.createElement('button');
                    btnDel.innerHTML = '<i class="fas fa-trash"></i>';
                    btnDel.style.cursor = "pointer";
                    btnDel.style.color = "red";
                    btnDel.onclick = () => delItem(item.id);

                    actions.appendChild(btnEdit);
                    actions.appendChild(btnDel);

                    card.appendChild(info);
                    card.appendChild(actions);
                    
                    // å°‡å¡ç‰‡å¯¦é«”æ’å…¥å®¹å™¨
                    container.appendChild(card);
                });
            });
        }

        // ç°¡å–®çš„æ–°å¢ä¿®æ”¹
        window.openModal = (id = null) => {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('editId').value = id || "";
            if(id) {
                const item = dayItems.find(x => x.id === id);
                document.getElementById('inLoc').value = item.location;
                document.getElementById('inTime').value = item.time;
                document.getElementById('inNote').value = item.note;
            } else {
                document.getElementById('inLoc').value = "";
                document.getElementById('inTime').value = "";
                document.getElementById('inNote').value = "";
            }
        }
        window.closeModal = () => document.getElementById('modal').style.display = 'none';

        window.saveData = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                tripId: currentTripId,
                day: parseInt(currentDay),
                location: document.getElementById('inLoc').value,
                time: document.getElementById('inTime').value,
                note: document.getElementById('inNote').value
            };
            
            if(id) await updateDoc(doc(db, "items", id), data);
            else await addDoc(collection(db, "items"), { ...data, createdAt: serverTimestamp() });
            
            closeModal();
        }
        window.delItem = async (id) => { if(confirm("åˆªé™¤?")) await deleteDoc(doc(db, "items", id)); }
    </script>
</body>
</html>
