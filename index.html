<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ä¼´ Go! V7.4 (é¡¯ç¤ºéš”é›¢æ¸¬è©¦)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f0f2f5; margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 250px; background: white; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #ddd;}
        .main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* æ¸¬è©¦ç”¨çš„ç°¡å–®å¡ç‰‡ */
        .simple-card {
            background: white; padding: 15px; margin-bottom: 10px; 
            border-left: 5px solid #007bff; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .debug-box {
            background: #333; color: #0f0; font-family: monospace; 
            padding: 10px; margin-bottom: 20px; border-radius: 5px; font-size: 14px;
        }

        button { padding: 10px; margin-top: 5px; cursor: pointer; width: 100%; }
        .day-btn { background: #eee; border: none; margin-bottom: 5px; text-align: left; }
        .day-btn.active { background: #007bff; color: white; }
        .add-btn { background: #28a745; color: white; border: none; border-radius: 5px; font-size: 1.2em;}
        
        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; width: 300px; border-radius: 10px; }
        input { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 id="tripTitle">è¼‰å…¥ä¸­...</h2>
        <div id="dayList"></div>
        <button onclick="location.reload()" style="margin-top:auto; background:#666; color:white; border:none;">é‡æ–°æ•´ç†</button>
    </div>

    <div class="main">
        <div id="debugConsole" class="debug-box">ç³»çµ±æº–å‚™å°±ç·’...</div>

        <div id="listArea"></div>
        
        <button class="add-btn" onclick="openModal()">+ æ–°å¢ç°¡å–®è¡Œç¨‹</button>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <h3>æ–°å¢è¡Œç¨‹</h3>
            <input type="text" id="locInput" placeholder="åœ°é»">
            <input type="time" id="timeInput">
            <button onclick="saveItem()" style="background:#007bff; color:white; border:none;">å„²å­˜</button>
            <button onclick="document.getElementById('myModal').style.display='none'" style="background:#ccc; border:none;">å–æ¶ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, doc, query, where, onSnapshot, setDoc, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYUTADnEjSDMd__T7n8xsoY5LFUn9qlDw",
            authDomain: "gogo-252ba.firebaseapp.com",
            projectId: "gogo-252ba",
            storageBucket: "gogo-252ba.firebasestorage.app",
            messagingSenderId: "599210924514",
            appId: "1:599210924514:web:15e78eb22c2b355e9b81bb",
            measurementId: "G-3VJRC7WZQB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentTripId = localStorage.getItem('lastTripId');
        let currentDay = 1;

        // é™¤éŒ¯è¼¸å‡ºå‡½å¼
        function log(msg) {
            const el = document.getElementById('debugConsole');
            el.innerHTML += `<br>> ${msg}`;
            console.log(msg);
        }

        // åˆå§‹åŒ–
        if(!currentTripId) {
            log("æ‰¾ä¸åˆ°è¡Œç¨‹ IDï¼Œè«‹å…ˆç”¨èˆŠç‰ˆå»ºç«‹è¡Œç¨‹");
            document.getElementById('tripTitle').innerText = "æœªè¼‰å…¥è¡Œç¨‹";
        } else {
            log(`æ­£åœ¨è®€å–è¡Œç¨‹ ID: ${currentTripId}`);
            loadTrip();
        }

        async function loadTrip() {
            const snap = await getDoc(doc(db, "trips", currentTripId));
            if(snap.exists()) {
                const data = snap.data();
                document.getElementById('tripTitle').innerText = data.name;
                renderDays(data.days);
                listenData();
            } else {
                log("è¡Œç¨‹ä¸å­˜åœ¨ï¼");
            }
        }

        function renderDays(total) {
            const div = document.getElementById('dayList');
            div.innerHTML = "";
            for(let i=1; i<=total; i++) {
                div.innerHTML += `<button class="day-btn ${i===currentDay?'active':''}" onclick="changeDay(${i})">Day ${i}</button>`;
            }
        }

        window.changeDay = (d) => {
            currentDay = d;
            log(`åˆ‡æ›åˆ° Day ${d}`);
            renderDays(5); // æš«æ™‚å¯«æ­»5å¤©é‡ç¹ªæŒ‰éˆ•ç‹€æ…‹
            listenData(); // é‡æ–°è§¸ç™¼ç›£è½
        }

        // æ ¸å¿ƒç›£è½å‡½å¼ (æ¥µç°¡ç‰ˆ)
        function listenData() {
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            
            onSnapshot(q, (snapshot) => {
                const listDiv = document.getElementById('listArea');
                listDiv.innerHTML = ""; // æ¸…ç©ºç•«é¢
                
                let count = 0;
                let validItems = [];

                log(`è³‡æ–™åº«å›æ‡‰ï¼šæ”¶åˆ° ${snapshot.size} ç­†ç¸½è³‡æ–™`);

                snapshot.forEach(doc => {
                    const data = doc.data();
                    // å¯¬é¬†æ¯”å°å¤©æ•¸
                    if(data.day == currentDay) {
                        validItems.push(data);
                    }
                });

                log(`Day ${currentDay} ç¬¦åˆçš„è³‡æ–™æœ‰ï¼š${validItems.length} ç­†`);

                if(validItems.length === 0) {
                    listDiv.innerHTML = "<p>é€™è£¡æ²’æœ‰è¡Œç¨‹</p>";
                }

                // é–‹å§‹ç¹ªè£½
                validItems.forEach((item, index) => {
                    log(`æ­£åœ¨ç¹ªè£½ç¬¬ ${index+1} ç­†ï¼š${item.location}`);
                    
                    // æœ€ç°¡å–®çš„ HTMLï¼Œä¸åšä»»ä½•è¤‡é›œé‹ç®—
                    const html = `
                        <div class="simple-card">
                            <h3>ğŸ“ ${item.location}</h3>
                            <p>ğŸ•’ æ™‚é–“ï¼š${item.time || "æœªè¨­å®š"}</p>
                            <small>ğŸ“ ${item.note || "ç„¡å‚™è¨»"}</small>
                        </div>
                    `;
                    listDiv.innerHTML += html;
                });
                
                if(validItems.length > 0) {
                    log("âœ… ç¹ªè£½å®Œæˆï¼å¦‚æœä½ æ²’çœ‹åˆ°åˆ—è¡¨ï¼Œä»£è¡¨æ˜¯ CSS è¢«æ“‹ä½äº†");
                }
            });
        }

        // ç°¡æ˜“æ–°å¢
        window.openModal = () => document.getElementById('myModal').style.display = 'flex';
        window.saveItem = async () => {
            const loc = document.getElementById('locInput').value;
            const time = document.getElementById('timeInput').value;
            await addDoc(collection(db, "items"), {
                tripId: currentTripId,
                day: parseInt(currentDay), // ç¢ºä¿æ˜¯æ•¸å­—
                location: loc,
                time: time,
                createdAt: serverTimestamp()
            });
            document.getElementById('myModal').style.display = 'none';
        }
    </script>
</body>
</html>
