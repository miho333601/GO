<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ä¼´ Go! V9.0 (è¦–è¦ºæµæš¢ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === åŸºç¤æ¨£å¼ === */
        body { font-family: 'Noto Sans TC', sans-serif; background: #f0f2f5; margin: 0; display: flex; height: 100vh; color: #333; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 260px; background: white; display: flex; flex-direction: column; border-right: 1px solid #ddd; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .sidebar-header { padding: 20px; background: linear-gradient(135deg, #4285F4 0%, #34A853 100%); color: white; }
        .day-list { list-style: none; padding: 10px; margin: 0; flex: 1; overflow-y: auto; }
        .day-btn { 
            width: 100%; padding: 12px 20px; border: none; background: white; 
            text-align: left; cursor: pointer; font-size: 16px; color: #5f6368;
            border-radius: 0 20px 20px 0; margin-bottom: 5px; transition: 0.2s;
        }
        .day-btn:hover { background: #f1f3f4; }
        .day-btn.active { background: #e8f0fe; color: #1967d2; font-weight: bold; }

        /* ä¸»å…§å®¹å€ */
        .main { flex: 1; display: flex; flex-direction: column; position: relative; background: #fff; }
        .top-bar { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: white; z-index: 10; }
        
        /* åˆ—è¡¨å€ */
        #listArea { 
            flex: 1; padding: 20px; overflow-y: auto; background-color: #f8f9fa; 
            padding-bottom: 100px;
        }

        /* === V9.0 æ–°ç‰ˆå¡ç‰‡æ¨£å¼ === */
        .timeline-container {
            display: flex; flex-direction: column; align-items: stretch;
        }

        .spot-card {
            background: white; padding: 0; margin: 0; /* ç§»é™¤ marginï¼Œæ”¹ç”±é€£æ¥å™¨æ§åˆ¶é–“è· */
            border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            display: flex; overflow: hidden; border: 1px solid #eee;
            transition: transform 0.2s; position: relative; z-index: 2;
        }
        .spot-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }

        .time-col {
            width: 70px; background: #e8f0fe; color: #1967d2;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-right: 1px solid #d2e3fc; padding: 10px; font-weight: bold;
        }
        
        .info-col { flex: 1; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
        .spot-title { font-size: 1.2em; font-weight: bold; color: #202124; margin-bottom: 8px; }
        
        .spot-details { font-size: 0.9em; color: #5f6368; display: flex; flex-direction: column; gap: 4px; }
        .detail-row { display: flex; align-items: center; gap: 6px; }
        .note-tag { background: #fff8e1; color: #f57f17; padding: 2px 8px; border-radius: 4px; font-size: 0.85em; display: inline-block;}

        .actions-col { display: flex; flex-direction: column; border-left: 1px solid #eee; width: 40px; }
        .act-btn { flex: 1; border: none; background: white; cursor: pointer; color: #9aa0a6; transition: 0.2s; display: flex; align-items: center; justify-content: center;}
        .act-btn:hover { background: #f8f9fa; color: #333; }
        .act-btn.del:hover { background: #fce8e6; color: #d93025; }

        /* === V9.0 äº¤é€šé€£æ¥å™¨æ¨£å¼ === */
        .transport-connector {
            display: flex; align-items: center; justify-content: center;
            padding: 10px 0; position: relative; color: #666; font-size: 0.85em;
        }
        /* è™›ç·š */
        .transport-connector::before {
            content: ''; position: absolute; top: 0; bottom: 0; left: 35px; /* å°é½Šå·¦å´ */
            width: 2px; background: repeating-linear-gradient(to bottom, #ccc 0, #ccc 4px, transparent 4px, transparent 8px);
            z-index: 0;
        }
        /* äº¤é€šæ¨™ç±¤ */
        .transport-badge {
            background: #f1f3f4; padding: 4px 12px; border-radius: 20px;
            z-index: 1; border: 1px solid #e0e0e0;
            display: flex; align-items: center; gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .transport-badge i { color: #1a73e8; }

        /* é™¤éŒ¯å€ */
        .debug-box { font-size: 12px; color: #aaa; padding: 10px; text-align: center; border-top: 1px solid #eee; }

        /* æŒ‰éˆ•èˆ‡å½ˆçª— */
        .fab-btn { 
            position: absolute; bottom: 30px; right: 30px; 
            width: 60px; height: 60px; border-radius: 50%; 
            background: linear-gradient(135deg, #4285F4 0%, #34A853 100%); 
            color: white; border: none; font-size: 28px; 
            cursor: pointer; box-shadow: 0 4px 15px rgba(66,133,244,0.4); 
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s; z-index: 100;
        }
        .fab-btn:active { transform: scale(0.95); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        
        input, select { width: 100%; padding: 12px; margin: 6px 0 15px 0; border: 1px solid #dadce0; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        label { font-weight: bold; font-size: 0.9em; color: #5f6368; }
        
        #mapPreview { width: 100%; height: 150px; background: #eee; border-radius: 8px; margin-bottom: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; color: #999; }

        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-cancel { background: #f1f3f4; color: #333; }
        
        .big-btn { width: 100%; padding: 12px; border:none; background:#34A853; color:white; border-radius:6px; cursor:pointer; margin-bottom:15px; display:flex; align-items:center; justify-content:center; gap:8px;}
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2 id="tripTitle" style="margin:0; font-size:1.4em;">è¼‰å…¥ä¸­...</h2>
            <small id="tripCode" style="opacity:0.8; cursor:pointer;">ä»£ç¢¼: ---</small>
        </div>
        <div id="dayList" class="day-list"></div>
        <div id="debugConsole" class="debug-box">ç³»çµ±å°±ç·’</div>
        <button onclick="if(confirm('ç¢ºå®šé€€å‡ºï¼Ÿ')){localStorage.removeItem('lastTripId');location.reload();}" style="padding:15px; border:none; background:none; cursor:pointer; color:#5f6368; border-top:1px solid #eee;">é€€å‡ºè¡Œç¨‹</button>
    </div>

    <div class="main">
        <div class="top-bar">
            <h2 id="currentDayTitle" style="margin:0; color:#202124;">Day 1</h2>
        </div>

        <div id="listArea"></div>
        
        <button class="fab-btn" onclick="openModal()">+</button>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#1a73e8;">ğŸ“ è¡Œç¨‹ç·¨è¼¯</h3>
            <input type="hidden" id="editId">

            <div id="route-box" style="display:none;">
                <button class="big-btn" onclick="openGoogleMapsRoute()">
                    <i class="fas fa-directions"></i> è¦åŠƒè·¯ç·š (å¾ä¸Šä¸€ç«™)
                </button>
            </div>

            <label>åœ°é»åç¨±</label>
            <input type="text" id="locInput" placeholder="ä¾‹å¦‚ï¼šå°åŒ—101" onblur="updateMap(this.value)">
            
            <div id="mapPreview">åœ°åœ–é è¦½å€</div>

            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>åˆ°é”æ™‚é–“</label>
                    <input type="time" id="timeInput">
                </div>
                <div style="flex:1;">
                    <label>é è¨ˆåœç•™ (åˆ†)</label>
                    <input type="number" id="durationInput" placeholder="90">
                </div>
            </div>

            <label>äº¤é€šæ–¹å¼ (å¦‚ä½•æŠµé”é€™è£¡?)</label>
            <select id="transportInput">
                <option value="ç„¡">è«‹é¸æ“‡...</option>
                <option value="é–‹è»Š">ğŸš— é–‹è»Š</option>
                <option value="å¤§çœ¾é‹è¼¸">ğŸš† å¤§çœ¾é‹è¼¸</option>
                <option value="æ­¥è¡Œ">ğŸš¶ æ­¥è¡Œ</option>
                <option value="å–®è»Š">ğŸš² å–®è»Š</option>
                <option value="å…¶ä»–">ğŸ›¸ å…¶ä»–</option>
            </select>

            <label>å‚™è¨»</label>
            <input type="text" id="noteInput" placeholder="ç¥¨åƒ¹ã€å¿…åƒ...">

            <div class="btn-group">
                <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveItem()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="landing" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="color:#1a73e8;">âœˆï¸ æ—…ä¼´ Go!</h1>
        <div style="width:260px; display:flex; flex-direction:column; gap:10px;">
            <input type="text" id="codeEnter" placeholder="è¼¸å…¥ä»£ç¢¼" style="text-align:center;">
            <button class="btn btn-primary" onclick="loadByCode()">è¼‰å…¥è¡Œç¨‹</button>
            <button class="btn btn-cancel" onclick="createNew()">å»ºç«‹æ–°è¡Œç¨‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, doc, query, where, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYUTADnEjSDMd__T7n8xsoY5LFUn9qlDw",
            authDomain: "gogo-252ba.firebaseapp.com",
            projectId: "gogo-252ba",
            storageBucket: "gogo-252ba.firebasestorage.app",
            messagingSenderId: "599210924514",
            appId: "1:599210924514:web:15e78eb22c2b355e9b81bb",
            measurementId: "G-3VJRC7WZQB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentTripId = localStorage.getItem('lastTripId');
        let currentDay = 1;
        let unsubscribe = null;
        let currentData = [];

        // åˆå§‹åŒ–
        if(currentTripId) {
            document.getElementById('codeEnter').value = currentTripId;
            getDoc(doc(db, "trips", currentTripId)).then(snap => {
                if(snap.exists()) initApp(snap.data());
                else document.getElementById('landing').style.display = 'flex';
            });
        }

        window.loadByCode = async () => {
            const code = document.getElementById('codeEnter').value;
            const snap = await getDoc(doc(db, "trips", code));
            if(snap.exists()) {
                currentTripId = code;
                localStorage.setItem('lastTripId', code);
                initApp(snap.data());
            } else alert("æ‰¾ä¸åˆ°ä»£ç¢¼");
        }

        window.createNew = async () => {
            const name = prompt("æ—…ç¨‹åç¨± (å¦‚ï¼šæ—¥æœ¬è¡Œ)");
            const days = prompt("å¤©æ•¸", "5");
            if(name && days) {
                const id = Math.floor(100000 + Math.random()*900000).toString();
                await setDoc(doc(db, "trips", id), { name, days: parseInt(days), createdAt: serverTimestamp() });
                currentTripId = id;
                localStorage.setItem('lastTripId', id);
                initApp({ name, days: parseInt(days) });
            }
        }

        function initApp(data) {
            document.getElementById('landing').style.display = 'none';
            document.getElementById('tripTitle').innerText = data.name;
            document.getElementById('tripCode').innerText = "ä»£ç¢¼: " + currentTripId;
            
            const div = document.getElementById('dayList');
            div.innerHTML = "";
            for(let i=1; i<=data.days; i++) {
                div.innerHTML += `<button id="btn-day-${i}" class="day-btn" onclick="changeDay(${i})">Day ${i}</button>`;
            }
            changeDay(1);
        }

        window.changeDay = (d) => {
            currentDay = d;
            document.getElementById('currentDayTitle').innerText = `Day ${d}`;
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-day-${d}`).classList.add('active');
            listenData();
        }

        // æ™‚é–“æ ¼å¼åŒ–å°å·¥å…·
        function formatDuration(minutes) {
            if(!minutes) return "";
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            if(h > 0 && m > 0) return `${h}å°æ™‚${m}åˆ†é˜`;
            if(h > 0) return `${h}å°æ™‚`;
            return `${m}åˆ†é˜`;
        }

        function listenData() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const listDiv = document.getElementById('listArea');
                listDiv.innerHTML = "";
                currentData = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.day == currentDay) currentData.push({ id: doc.id, ...data });
                });

                currentData.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));
                document.getElementById('debugConsole').innerText = `D${currentDay}: ${currentData.length} ç­†`;

                if(currentData.length === 0) listDiv.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:50px;'>ğŸ“­ å°šç„¡è¡Œç¨‹ï¼Œé» + æ–°å¢</div>";

                currentData.forEach((item, index) => {
                    // 1. å¦‚æœä¸æ˜¯ç¬¬ä¸€ç­†ï¼Œä¸”æœ‰äº¤é€šæ–¹å¼ï¼Œæ’å…¥ã€Œäº¤é€šé€£æ¥å™¨ã€
                    if (index > 0 && item.transport && item.transport !== 'ç„¡') {
                        let icon = 'fas fa-arrow-down';
                        if(item.transport.includes('é–‹è»Š')) icon = 'fas fa-car';
                        else if(item.transport.includes('å¤§çœ¾')) icon = 'fas fa-subway';
                        else if(item.transport.includes('æ­¥')) icon = 'fas fa-walking';
                        else if(item.transport.includes('å–®è»Š')) icon = 'fas fa-bicycle';
                        
                        listDiv.innerHTML += `
                            <div class="transport-connector">
                                <div class="transport-badge">
                                    <i class="${icon}"></i> ${item.transport}
                                </div>
                            </div>
                        `;
                    }

                    // 2. æ ¼å¼åŒ–åœç•™æ™‚é–“
                    const durationText = formatDuration(item.duration);
                    
                    // 3. æ¸²æŸ“å¡ç‰‡
                    const timeDisplay = item.time || "--:--";
                    const locDisplay = item.location || "æœªå‘½å";
                    const noteHtml = item.note ? `<div class="detail-row"><span class="note-tag"><i class="far fa-sticky-note"></i> ${item.note}</span></div>` : '';
                    const durationHtml = durationText ? `<div class="detail-row"><i class="far fa-clock" style="color:#aaa;"></i> é è¨ˆåœç•™ ${durationText}</div>` : '';

                    listDiv.innerHTML += `
                        <div class="spot-card">
                            <div class="time-col">
                                <div>${timeDisplay}</div>
                            </div>
                            <div class="info-col">
                                <div class="spot-title">${locDisplay}</div>
                                <div class="spot-details">
                                    ${durationHtml}
                                    ${noteHtml}
                                </div>
                            </div>
                            <div class="actions-col">
                                <button class="act-btn" onclick="openModal('${item.id}')"><i class="fas fa-pen"></i></button>
                                <button class="act-btn del" onclick="delItem('${item.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // Google Maps & Modal
        window.updateMap = (loc) => {
            const div = document.getElementById('mapPreview');
            if(!loc) div.innerHTML = "åœ°åœ–é è¦½å€";
            else div.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://www.google.com/maps?q=${encodeURIComponent(loc)}&output=embed"></iframe>`;
        }

        window.openModal = (id = null) => {
            document.getElementById('myModal').style.display = 'flex';
            document.getElementById('editId').value = id || "";
            updateMap('');

            if(id) {
                const item = currentData.find(x => x.id === id);
                document.getElementById('locInput').value = item.location;
                document.getElementById('timeInput').value = item.time;
                document.getElementById('durationInput').value = item.duration || "";
                document.getElementById('transportInput').value = item.transport || "ç„¡";
                document.getElementById('noteInput').value = item.note || "";
                document.getElementById('route-box').style.display = 'none';
                updateMap(item.location);
            } else {
                ['locInput','timeInput','durationInput','noteInput'].forEach(i => document.getElementById(i).value = '');
                document.getElementById('transportInput').value = "ç„¡";
                
                // ä¸Šä¸€ç«™æŒ‰éˆ•é‚è¼¯
                const routeBox = document.getElementById('route-box');
                if(currentData.length > 0) {
                    routeBox.style.display = 'block';
                    window.lastLoc = currentData[currentData.length - 1].location;
                } else {
                    routeBox.style.display = 'none';
                }
            }
        }
        
        window.openGoogleMapsRoute = () => {
            const current = document.getElementById('locInput').value;
            let url = `https://www.google.com/maps?q=${encodeURIComponent(window.lastLoc)}`;
            if(current) url += `/${encodeURIComponent(current)}`;
            window.open(url, '_blank');
        }

        window.closeModal = () => document.getElementById('myModal').style.display = 'none';

        window.saveItem = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                tripId: currentTripId,
                day: parseInt(currentDay),
                location: document.getElementById('locInput').value,
                time: document.getElementById('timeInput').value,
                duration: document.getElementById('durationInput').value,
                transport: document.getElementById('transportInput').value,
                note: document.getElementById('noteInput').value
            };
            if(!data.location) return alert("åœ°é»å¿…å¡«");
            if(id) await updateDoc(doc(db, "items", id), data);
            else await addDoc(collection(db, "items"), { ...data, createdAt: serverTimestamp() });
            closeModal();
        }

        window.delItem = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "items", id)); }
        
        // Export
        window.changeDay = changeDay;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveItem = saveItem;
        window.delItem = delItem;
        window.updateMap = updateMap;
        window.openGoogleMapsRoute = openGoogleMapsRoute;
        window.loadByCode = loadByCode;
        window.createNew = createNew;
    </script>
</body>
</html>
