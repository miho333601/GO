<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ä¼´ Go! V14.0 (å®¶åº­å”ä½œç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4285F4; --bg: #f8f9fa; --card-bg: #ffffff; --text-main: #333; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: var(--text-main); overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        .app-container { display: flex; width: 100%; height: 100%; flex-direction: column; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 300px; background: white; border-right: 1px solid #eee; display: none; flex-direction: column; padding: 20px; }
        .sidebar-header { margin-bottom: 10px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .sidebar-btn { display: block; width: 100%; padding: 12px 15px; border: none; background: transparent; text-align: left; cursor: pointer; border-radius: 8px; font-size: 15px; color: #555; margin-bottom: 5px; transition: 0.2s; }
        .sidebar-btn:hover { background: #f1f3f4; }
        .sidebar-btn.active { background: #e8f0fe; color: var(--primary); font-weight: bold; }
        .sidebar-date { float: right; font-size: 0.85em; color: #888; font-weight: normal; }

        /* è²¡å‹™å ±è¡¨ */
        .cost-summary { margin-top: auto; padding: 15px; background: #fff8e1; border-radius: 12px; font-size: 0.9em; border: 1px solid #ffe0b2; }
        .cost-row { display: flex; justify-content: space-between; margin-bottom: 5px; color: #5d4037; }
        .cost-row.total { border-top: 1px dashed #d7ccc8; margin-top: 5px; padding-top: 5px; font-weight: bold; color: #d84315; }

        /* æ‰‹æ©Ÿå°èˆª */
        .mobile-header { background: white; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; }
        .header-left { display: flex; flex-direction: column; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .app-title { font-weight: bold; font-size: 1.2em; color: var(--primary); margin: 0; display:flex; align-items:center; gap:8px;}
        .trip-code { font-size: 0.8em; color: #666; background: #f1f3f4; padding: 4px 8px; border-radius: 12px; cursor: pointer; display: inline-block; margin-top: 4px;}
        
        .tool-icon { font-size: 1.1em; padding: 8px; cursor: pointer; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: #f1f3f4; color: #555; }
        .tool-icon.logout { color: #d93025; background: #ffebee; }
        .tool-icon.money { color: #f57f17; background: #fff8e1; }

        /* å¤©æ•¸åˆ— */
        .mobile-days-bar { display: flex; overflow-x: auto; background: white; padding: 10px 15px; border-bottom: 1px solid #eee; white-space: nowrap; gap: 10px; scrollbar-width: none; }
        .mobile-days-bar::-webkit-scrollbar { display: none; }
        .day-pill { display: inline-block; padding: 8px 16px; border-radius: 20px; background: #f1f3f4; color: #666; font-size: 0.9em; cursor: pointer; transition: 0.2s; flex-shrink: 0; text-align: center;}
        .day-pill small { display: block; font-size: 0.8em; opacity: 0.8; margin-top: -2px; }
        .day-pill.active { background: var(--primary); color: white; box-shadow: 0 2px 6px rgba(66,133,244,0.3); }

        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 120px; position: relative; }

        /* å¡ç‰‡ */
        .spot-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 0; display: flex; overflow: hidden; border: 1px solid #f0f0f0; position: relative; z-index: 2; }
        .time-col { width: 75px; background: #e8f0fe; color: #1967d2; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; font-weight: 700; font-size: 0.95em; text-align: center; border-right: 1px solid #dbeafe; }
        .info-col { flex: 1; padding: 15px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .spot-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 0.8em; padding: 3px 8px; border-radius: 6px; background: #f5f5f5; color: #666; display: flex; align-items: center; gap: 4px; }
        .badge.stay { background: #e0f2f1; color: #00695c; }
        .badge.cost { background: #fff8e1; color: #f57f17; border: 1px solid #ffe0b2; }
        .badge.creator { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; } /* é¡¯ç¤ºèª°æ–°å¢çš„ */
        
        .actions-col { width: 45px; border-left: 1px solid #f0f0f0; display: flex; flex-direction: column; }
        .act-btn { flex: 1; border: none; background: white; color: #ccc; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .act-btn:hover { background: #f5f5f5; color: var(--primary); }
        .act-btn.del:hover { color: #d32f2f; background: #ffebee; }

        /* äº¤é€š */
        .transport-connector { display: flex; align-items: center; justify-content: center; padding: 12px 0; position: relative; }
        .transport-connector::before { content: ''; position: absolute; top: 0; bottom: 0; left: 37px; width: 2px; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 6px, transparent 6px, transparent 12px); z-index: 0; }
        .transport-pill { background: white; border: 1px solid #eee; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; color: #666; position: relative; z-index: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 6px; }
        .transport-pill i { color: var(--primary); }

        .fab-btn { position: absolute; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 15px rgba(66,133,244,0.4); font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; z-index: 100; }
        .fab-btn:active { transform: scale(0.9); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; transition: opacity 0.3s; }
        .modal-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; transition: bottom 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); max-height: 90vh; overflow-y: auto; }
        .modal-active .modal-overlay { display: block; opacity: 1; }
        .modal-active .modal-sheet { bottom: 0; }

        #mapPreview { width: 100%; height: 150px; background: #eee; border-radius: 10px; margin-top: 10px; margin-bottom: 15px; overflow: hidden; display: flex; align-items: center; justify-content: center; color: #999; font-size: 0.9em; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9em; font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #fff; appearance: none; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .btn-full { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-cancel { background: #f1f3f4; color: #333; margin-top: 10px; }
        .btn-map { background: #e8f0fe; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;}

        /* åˆ†å¸³åŠŸèƒ½å€å¡Š */
        .split-bill-box { background: #fff8e1; padding: 15px; border-radius: 12px; border: 1px solid #ffe0b2; margin-bottom: 15px; }
        .split-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .split-row:last-child { border-bottom: none; margin-bottom: 0; }
        .split-name { font-weight: bold; color: #5d4037; }
        .split-input { width: 60px; padding: 5px; text-align: center; border: 1px solid #d7ccc8; border-radius: 5px; }
        
        .role-badge { font-size: 0.6em; padding: 2px 6px; border-radius: 4px; vertical-align: middle; white-space: nowrap;}
        .role-editor { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .role-viewer { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        /* æ­¡è¿é  */
        #landing { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        .landing-options { width: 100%; max-width: 300px; }
        .landing-form { display: none; width: 100%; max-width: 300px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .landing-input { width: 100%; padding: 15px; font-size: 18px; text-align: center; border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px; }

        @media (min-width: 769px) {
            .app-container { flex-direction: row; }
            .sidebar { display: flex; }
            .mobile-header, .mobile-days-bar { display: none; }
            .modal-sheet { width: 450px; left: 50%; top: 50%; bottom: auto !important; transform: translate(-50%, -50%) scale(0.95); border-radius: 16px; opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; }
            .modal-active .modal-sheet { opacity: 1; pointer-events: auto; bottom: auto !important; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>

    <div id="landing">
        <h1 style="color:var(--primary); font-size: 2.5em; margin-bottom: 10px;">æ—…ä¼´ Go!</h1>
        <p style="color:#888; margin-bottom: 40px;">è«‹å…ˆé¸æ“‡èº«åˆ†</p>
        
        <div id="landingStep1" class="landing-form" style="display:block;">
            <input type="text" id="codeEnter" class="landing-input" placeholder="è«‹è¼¸å…¥ 6 ç¢¼è¡Œç¨‹ä»£ç¢¼">
            <button class="btn-full btn-primary" onclick="checkTripCode()">ä¸‹ä¸€æ­¥</button>
            <button class="btn-full btn-cancel" onclick="showCreate()">å»ºç«‹æ–°è¡Œç¨‹</button>
        </div>

        <div id="landingStep2" class="landing-form">
            <h3 style="margin:0 0 15px 0;">è«‹å•æ‚¨æ˜¯ï¼Ÿ</h3>
            <select id="familySelect" class="landing-input">
                </select>
            <input type="password" id="passEnter" class="landing-input" placeholder="ç®¡ç†å“¡å¯†ç¢¼ (ä¸€èˆ¬æˆå“¡å…å¡«)">
            <button class="btn-full btn-primary" onclick="loginWithFamily()">é€²å…¥è¡Œç¨‹</button>
            <button class="btn-full btn-cancel" onclick="backToStep1()">è¿”å›</button>
        </div>

        <div id="landingCreate" class="landing-form">
            <h3 style="margin:0 0 15px 0;">å»ºç«‹æ–°æ—…ç¨‹</h3>
            <input type="text" id="newTripName" class="landing-input" placeholder="æ—…ç¨‹åç¨±" style="text-align:left;">
            <div class="form-group" style="text-align:left;">
                <label>åƒèˆ‡å®¶åº­/æˆå“¡ (é€—è™Ÿåˆ†éš”)</label>
                <input type="text" id="newTripGroups" placeholder="ä¾‹å¦‚ï¼šé™³å®¶, æ—å®¶, ç‹å®¶" value="é™³å®¶, æ—å®¶">
            </div>
            <div class="form-group" style="text-align:left;"><label>ç®¡ç†å“¡å¯†ç¢¼</label><input type="text" id="newTripPass" placeholder="è¨­å®šå¯†ç¢¼"></div>
            <div class="row form-group" style="text-align:left;">
                <div class="col"><label>å‡ºç™¼</label><input type="date" id="newTripDate"></div>
                <div class="col"><label>å¤©æ•¸</label><input type="number" id="newTripDays" value="5"></div>
            </div>
            <button class="btn-full btn-primary" onclick="createNewTrip()">å»ºç«‹</button>
            <button class="btn-full btn-cancel" onclick="backToStep1()">å–æ¶ˆ</button>
        </div>
    </div>

    <div class="app-container" id="app" style="display:none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:8px;">
                    <h2 id="pcTripTitle" style="margin:0;">...</h2>
                    <span id="pcRoleBadge" class="role-badge"></span>
                </div>
                <small id="pcTripCode" style="color:#666; display:block; margin-top:5px; cursor:pointer;" onclick="copyCode()">ä»£ç¢¼: --- <i class="far fa-copy"></i></small>
            </div>
            <div id="pcDayList" class="day-list" style="flex:1;"></div>
            <div id="pcCostSummary" class="cost-summary"></div>
            <button class="btn-full btn-cancel" style="margin-top:10px;" onclick="logout()">é€€å‡º</button>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; height:100%;">
            <div class="mobile-header">
                <div class="header-left">
                    <div class="app-title"><span id="mobileTripTitle">è¡Œç¨‹</span><span id="mobileRoleBadge" class="role-badge"></span></div>
                    <span class="trip-code" id="mobileCode" onclick="copyCode()">ä»£ç¢¼: ---</span>
                </div>
                <div class="header-right">
                    <div class="tool-icon money" onclick="showMoneyModal()" title="å¸³æœ¬"><i class="fas fa-file-invoice-dollar"></i></div>
                    <div class="tool-icon logout" onclick="logout()" title="é€€å‡º"><i class="fas fa-sign-out-alt"></i></div>
                </div>
            </div>

            <div class="mobile-days-bar" id="mobileDayList"></div>
            <div class="main-content" id="listArea"></div>
            <button id="fabBtn" class="fab-btn" onclick="openItemModal()"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>
    <div id="itemModalSheet" class="modal-sheet">
        <h3 style="margin-top:0; color:var(--primary);">ğŸ“ è¡Œç¨‹è³‡æ–™</h3>
        <input type="hidden" id="editId">
        <button class="btn-full btn-map" id="routeBtn" onclick="openGoogleMapsRoute()" style="display:none;"><i class="fas fa-map-marked-alt"></i> é–‹å•Ÿ Google Maps å°èˆª</button>
        <div class="form-group"><label>åœ°é»</label><input type="text" id="locInput" placeholder="ä¾‹å¦‚ï¼šè¿ªå£«å°¼æ¨‚åœ’" onblur="updateMapPreview(this.value)"></div>
        <div id="mapPreview">åœ°åœ–é è¦½å€</div>
        <div class="row form-group">
            <div class="col"><label>åˆ°é”æ™‚é–“</label><input type="time" id="timeInput"></div>
            <div class="col"><label>åœç•™(åˆ†)</label><input type="number" id="durationInput" placeholder="120"></div>
        </div>
        <div class="form-group">
            <label>äº¤é€š</label>
            <div class="row">
                <div class="col" style="flex:2;"><select id="transportInput"><option value="ç„¡">ç„¡</option><option value="é–‹è»Š">ğŸš— é–‹è»Š</option><option value="å¤§çœ¾é‹è¼¸">ğŸš† å¤§çœ¾é‹è¼¸</option><option value="æ­¥è¡Œ">ğŸš¶ æ­¥è¡Œ</option></select></div>
                <div class="col" style="flex:1;"><input type="number" id="travelTimeInput" placeholder="åˆ†"></div>
            </div>
        </div>
        
        <div class="split-bill-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label style="margin:0;"><i class="fas fa-coins"></i> è¨˜å¸³ (é¸å¡«)</label>
                <small id="totalPriceDisplay" style="color:#d84315; font-weight:bold;">ç¸½è¨ˆ: $0</small>
            </div>
            <div class="form-group">
                <input type="number" id="unitPriceInput" placeholder="è¼¸å…¥å–®åƒ¹ (0å‰‡ä¸è¨˜å¸³)" oninput="calcTotal()">
            </div>
            <div id="familySplitList"></div>
        </div>

        <div class="form-group"><label>å‚™è¨»</label><input type="text" id="noteInput" placeholder="å‚™è¨»..."></div>
        
        <button id="btnSave" class="btn-full btn-primary" onclick="saveItem()">å„²å­˜</button>
        <button class="btn-full btn-cancel" onclick="closeAllModals()">å–æ¶ˆ/é—œé–‰</button>
    </div>

    <div id="moneyModalSheet" class="modal-sheet">
        <h3 style="margin-top:0; color:#f57f17;"><i class="fas fa-file-invoice-dollar"></i> æ—…ç¨‹ç¸½å¸³æœ¬</h3>
        <div id="mobileCostSummary" class="cost-summary" style="background:white; border:none; padding:0;"></div>
        <button class="btn-full btn-cancel" onclick="closeAllModals()">é—œé–‰</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, doc, query, where, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYUTADnEjSDMd__T7n8xsoY5LFUn9qlDw",
            authDomain: "gogo-252ba.firebaseapp.com",
            projectId: "gogo-252ba",
            storageBucket: "gogo-252ba.firebasestorage.app",
            messagingSenderId: "599210924514",
            appId: "1:599210924514:web:15e78eb22c2b355e9b81bb",
            measurementId: "G-3VJRC7WZQB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentTripId = localStorage.getItem('lastTripId');
        let currentFamily = localStorage.getItem('lastFamily'); // å„²å­˜èº«åˆ†
        let currentPass = localStorage.getItem('lastTripPass');
        
        let currentDay = 1;
        let unsubscribe = null;
        let currentData = [];
        let tripData = null;
        let isEditor = false;

        // V14.0: ç™»å…¥é‚è¼¯é‡æ§‹
        if(currentTripId && currentFamily) {
            // è‡ªå‹•ç™»å…¥
            document.getElementById('codeEnter').value = currentTripId;
            document.getElementById('landingStep1').style.display = 'none';
            // ç›´æ¥æª¢æŸ¥ä¸¦é€²å…¥
            checkTripCode(true); 
        }

        window.showCreate = () => {
            document.getElementById('landingStep1').style.display = 'none';
            document.getElementById('landingCreate').style.display = 'block';
        }
        window.backToStep1 = () => {
            document.getElementById('landingStep1').style.display = 'block';
            document.getElementById('landingStep2').style.display = 'none';
            document.getElementById('landingCreate').style.display = 'none';
        }

        // æ­¥é©Ÿä¸€ï¼šæª¢æŸ¥ä»£ç¢¼
        window.checkTripCode = async (isAuto = false) => {
            const code = document.getElementById('codeEnter').value.trim();
            if(!code) return alert("è«‹è¼¸å…¥ä»£ç¢¼");

            try {
                const snap = await getDoc(doc(db, "trips", code));
                if(snap.exists()) {
                    tripData = snap.data();
                    currentTripId = code;
                    
                    if(isAuto) {
                        // è‡ªå‹•ç™»å…¥æµç¨‹
                        verifyAndEnter(currentPass);
                    } else {
                        // æ‰‹å‹•ç™»å…¥ï¼šé¡¯ç¤ºå®¶åº­é¸å–®
                        document.getElementById('landingStep1').style.display = 'none';
                        document.getElementById('landingStep2').style.display = 'block';
                        
                        const sel = document.getElementById('familySelect');
                        sel.innerHTML = '<option value="">è«‹é¸æ“‡æ‚¨çš„èº«åˆ†...</option>';
                        if(tripData.groups) {
                            tripData.groups.forEach(g => {
                                sel.innerHTML += `<option value="${g}">${g}</option>`;
                            });
                        }
                    }
                } else {
                    alert("æ‰¾ä¸åˆ°ä»£ç¢¼");
                    if(isAuto) { localStorage.clear(); location.reload(); }
                }
            } catch(e) {
                console.error(e);
                alert("é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            }
        }

        // æ­¥é©ŸäºŒï¼šé¸æ“‡èº«åˆ†ä¸¦ç™»å…¥
        window.loginWithFamily = () => {
            const family = document.getElementById('familySelect').value;
            const pass = document.getElementById('passEnter').value.trim();
            if(!family) return alert("è«‹é¸æ“‡æ‚¨çš„èº«åˆ†");
            
            currentFamily = family;
            localStorage.setItem('lastTripId', currentTripId);
            localStorage.setItem('lastFamily', family);
            
            verifyAndEnter(pass);
        }

        function verifyAndEnter(pass) {
            // é©—è­‰å¯†ç¢¼æ±ºå®šæ¬Šé™
            if (pass && tripData.password && pass === tripData.password) {
                isEditor = true; // ç®¡ç†å“¡
                localStorage.setItem('lastTripPass', pass);
            } else {
                isEditor = false; // ä¸€èˆ¬æˆå“¡
                if(pass) alert("å¯†ç¢¼éŒ¯èª¤ï¼Œæ‚¨å°‡ä»¥ã€Œä¸€èˆ¬æˆå“¡ã€èº«åˆ†é€²å…¥");
                localStorage.removeItem('lastTripPass');
            }
            initApp();
        }

        window.createNewTrip = async () => {
            const name = document.getElementById('newTripName').value;
            const pass = document.getElementById('newTripPass').value.trim();
            const date = document.getElementById('newTripDate').value;
            const days = document.getElementById('newTripDays').value;
            const groupsStr = document.getElementById('newTripGroups').value;
            
            if(!name || !days || !pass || !groupsStr) return alert("è«‹å¡«å¯«å®Œæ•´");

            const groups = groupsStr.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s);
            const id = Math.floor(100000 + Math.random()*900000).toString();
            
            try {
                const newTrip = { name, password: pass, startDate: date, days: parseInt(days), groups, createdAt: serverTimestamp() };
                await setDoc(doc(db, "trips", id), newTrip);
                
                // å»ºç«‹è€…è‡ªå‹•æ˜¯ç¬¬ä¸€å€‹å®¶åº­ä¸”æ˜¯ç®¡ç†å“¡
                currentTripId = id; currentFamily = groups[0]; isEditor = true; tripData = newTrip;
                localStorage.setItem('lastTripId', id); localStorage.setItem('lastFamily', currentFamily); localStorage.setItem('lastTripPass', pass);
                initApp();
            } catch(e) { alert("å»ºç«‹å¤±æ•—ï¼š" + e.message); }
        }

        function initApp() {
            document.getElementById('landing').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            document.getElementById('mobileTripTitle').innerText = tripData.name;
            document.getElementById('pcTripTitle').innerText = tripData.name;
            document.getElementById('mobileCode').innerText = `ä»£ç¢¼: ${currentTripId}`;
            document.getElementById('pcTripCode').innerHTML = `ä»£ç¢¼: ${currentTripId} <i class="far fa-copy"></i>`;

            const mBadge = document.getElementById('mobileRoleBadge');
            const pcBadge = document.getElementById('pcRoleBadge');
            
            let badgeText = isEditor ? `${currentFamily} (ç®¡ç†å“¡)` : `${currentFamily}`;
            let badgeClass = isEditor ? "role-badge role-editor" : "role-badge role-viewer";
            
            mBadge.innerText = badgeText; mBadge.className = badgeClass;
            pcBadge.innerText = badgeText; pcBadge.className = badgeClass;

            // ä¸€èˆ¬æˆå“¡ä¹Ÿèƒ½çœ‹åˆ°æ–°å¢æŒ‰éˆ• (V14.0 æ”¹å‹•)
            document.getElementById('fabBtn').style.display = "flex";

            renderDayNav(tripData.days);
            changeDay(1);
            listenAllCosts(); 
        }

        function listenAllCosts() {
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            onSnapshot(q, (snapshot) => {
                let summary = {}; let grandTotal = 0;
                if(tripData.groups) tripData.groups.forEach(g => summary[g] = 0);

                snapshot.forEach(doc => {
                    const item = doc.data();
                    if(item.splitData) {
                        for(let family in item.splitData) {
                            const cost = item.splitData[family].cost || 0;
                            if(summary[family] !== undefined) summary[family] += cost;
                            grandTotal += cost;
                        }
                    }
                });

                let html = "";
                for(let family in summary) html += `<div class="cost-row"><span class="split-name">${family}</span><span>$${summary[family].toLocaleString()}</span></div>`;
                html += `<div class="cost-row total"><span>ç¸½æ”¯å‡º</span><span>$${grandTotal.toLocaleString()}</span></div>`;
                document.getElementById('pcCostSummary').innerHTML = html;
                document.getElementById('mobileCostSummary').innerHTML = html;
            });
        }

        function getDayLabel(dayIndex) {
            if (!tripData.startDate) return `Day ${dayIndex}`;
            const targetDate = new Date(tripData.startDate);
            targetDate.setDate(targetDate.getDate() + (dayIndex - 1));
            const month = targetDate.getMonth() + 1; const date = targetDate.getDate();
            const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][targetDate.getDay()];
            return `Day ${dayIndex} <small>${month}/${date} (${week})</small>`;
        }

        function renderDayNav(totalDays) {
            const pcList = document.getElementById('pcDayList');
            const mobileList = document.getElementById('mobileDayList');
            pcList.innerHTML = ''; mobileList.innerHTML = '';
            for(let i=1; i<=totalDays; i++) {
                const label = getDayLabel(i);
                const pcBtn = document.createElement('button');
                pcBtn.id = `pc-day-${i}`; pcBtn.className = 'sidebar-btn';
                pcBtn.innerHTML = `Day ${i} <span class="sidebar-date">${label.split('<small>')[1].replace('</small>','')}</span>`;
                pcBtn.onclick = () => changeDay(i);
                pcList.appendChild(pcBtn);
                const mBtn = document.createElement('div');
                mBtn.id = `mobile-day-${i}`; mBtn.className = 'day-pill';
                mBtn.innerHTML = label;
                mBtn.onclick = () => changeDay(i);
                mobileList.appendChild(mBtn);
            }
        }

        window.changeDay = (d) => {
            currentDay = d;
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.day-pill').forEach(b => b.classList.remove('active'));
            const pcBtn = document.getElementById(`pc-day-${d}`);
            const mobileBtn = document.getElementById(`mobile-day-${d}`);
            if(pcBtn) pcBtn.classList.add('active');
            if(mobileBtn) { mobileBtn.classList.add('active'); mobileBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }
            listenData();
        }

        function formatDuration(m) {
            if(!m) return "";
            const h = Math.floor(m / 60); const min = m % 60;
            return h > 0 ? `${h}æ™‚${min}åˆ†` : `${min}åˆ†é˜`;
        }

        function listenData() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            unsubscribe = onSnapshot(q, (snapshot) => {
                const listDiv = document.getElementById('listArea');
                listDiv.innerHTML = "";
                currentData = [];
                snapshot.forEach(doc => { const data = doc.data(); if(data.day == currentDay) currentData.push({ id: doc.id, ...data }); });
                currentData.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));

                if(currentData.length === 0) { listDiv.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:50px;'><i class='fas fa-map-signs' style='font-size:3em;opacity:0.3;'></i><br><br>é€™è£¡é‚„æ²’æœ‰è¡Œç¨‹</div>"; return; }

                currentData.forEach((item, index) => {
                    if (index > 0 && item.transport && item.transport !== 'ç„¡') {
                        let icon = 'fas fa-arrow-down';
                        if(item.transport.includes('é–‹è»Š')) icon = 'fas fa-car';
                        else if(item.transport.includes('å¤§çœ¾')) icon = 'fas fa-subway';
                        else if(item.transport.includes('æ­¥')) icon = 'fas fa-walking';
                        let timeHtml = item.travelDuration ? `<span>â±ï¸ ${formatDuration(item.travelDuration)}</span>` : '';
                        listDiv.innerHTML += `<div class="transport-connector"><div class="transport-pill"><i class="${icon}"></i> ${item.transport} ${timeHtml}</div></div>`;
                    }
                    const stayHtml = item.duration ? `<span class="badge stay"><i class="far fa-clock"></i> åœ ${formatDuration(item.duration)}</span>` : '';
                    const noteHtml = item.note ? `<span class="badge note"><i class="far fa-sticky-note"></i> ${item.note}</span>` : '';
                    let costHtml = item.totalCost > 0 ? `<span class="badge cost"><i class="fas fa-coins"></i> ç¸½è¨ˆ $${item.totalCost.toLocaleString()}</span>` : '';
                    
                    // V14.0: é¡¯ç¤ºæ–°å¢è€…
                    const creatorHtml = item.createdBy ? `<span class="badge creator"><i class="fas fa-user"></i> ${item.createdBy}</span>` : '';

                    // V14.0: æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯ (ç®¡ç†å“¡å¯å…¨æ”¹ï¼Œä¸€èˆ¬äººä¸èƒ½æ”¹)
                    let actionButtons = '';
                    if(isEditor) {
                        actionButtons = `<div class="actions-col"><button class="act-btn" onclick="openItemModal('${item.id}')"><i class="fas fa-pen"></i></button><button class="act-btn del" onclick="delItem('${item.id}')"><i class="fas fa-trash"></i></button></div>`;
                    } else {
                        // ä¸€èˆ¬æˆå“¡åªèƒ½çœ‹ï¼Œä¸èƒ½æ”¹ (æŒ‰éˆ•éš±è—)
                        // è‹¥å¸Œæœ›ä¸€èˆ¬æˆå“¡èƒ½æ”¹ã€Œè‡ªå·±å»ºçš„ã€ï¼Œå¯åœ¨æ­¤åŠ åˆ¤æ–·: if(item.createdBy === currentFamily) ...
                    }

                    listDiv.innerHTML += `
                        <div class="spot-card">
                            <div class="time-col"><div>${item.time || "--:--"}</div></div>
                            <div class="info-col"><div class="spot-title">${item.location}</div><div class="badges">${creatorHtml}${stayHtml}${costHtml}${noteHtml}</div></div>
                            ${actionButtons}
                        </div>`;
                });
            });
        }

        window.closeAllModals = () => {
            document.body.classList.remove('modal-active');
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('itemModalSheet').style.bottom = '-100%';
            document.getElementById('moneyModalSheet').style.bottom = '-100%';
        }

        window.showMoneyModal = () => {
            document.body.classList.add('modal-active');
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('moneyModalSheet').style.bottom = '0';
        }

        window.openItemModal = (id = null) => {
            // V14.0: ä»»ä½•äººéƒ½èƒ½æ‰“é–‹æ–°å¢ï¼Œä½†åªæœ‰ç®¡ç†å“¡èƒ½æ‰“é–‹ç·¨è¼¯
            if(id && !isEditor) return; 

            document.body.classList.add('modal-active');
            document.getElementById('modalOverlay').style.display = 'block';
            const sheet = document.getElementById('itemModalSheet');
            if(window.innerWidth >= 769) { sheet.style.opacity = '1'; sheet.style.pointerEvents = 'auto'; } else { sheet.style.bottom = '0'; }

            document.getElementById('editId').value = id || "";
            const routeBtn = document.getElementById('routeBtn');
            const btnSave = document.getElementById('btnSave');
            window.updateMapPreview('');

            // V14.0: æ¬Šé™æ§åˆ¶æŒ‰éˆ•
            if(id && !isEditor) {
                btnSave.style.display = 'none'; // å”¯è®€æ¨¡å¼ä¸é¡¯ç¤ºå„²å­˜
            } else {
                btnSave.style.display = 'block';
            }

            // ç”Ÿæˆå®¶åº­åˆ—è¡¨
            const splitList = document.getElementById('familySplitList');
            splitList.innerHTML = '';
            if(tripData.groups) {
                tripData.groups.forEach(family => {
                    // æ™ºæ…§é å¡«ï¼šå¦‚æœæ˜¯è‡ªå·±ï¼Œä¸”æ˜¯æ–°å¢æ¨¡å¼ï¼Œé è¨­å¡« 1
                    let defaultQty = (!id && family === currentFamily) ? 1 : "";
                    
                    splitList.innerHTML += `
                        <div class="split-row">
                            <span class="split-name">${family}</span>
                            <div><input type="number" class="split-input" id="qty-${family}" placeholder="0" value="${defaultQty}" oninput="calcTotal()"><small>å€‹</small></div>
                        </div>`;
                });
            }

            if(id) {
                const item = currentData.find(x => x.id === id);
                document.getElementById('locInput').value = item.location;
                document.getElementById('timeInput').value = item.time;
                document.getElementById('durationInput').value = item.duration || "";
                document.getElementById('transportInput').value = item.transport || "ç„¡";
                document.getElementById('travelTimeInput').value = item.travelDuration || "";
                document.getElementById('noteInput').value = item.note || "";
                document.getElementById('unitPriceInput').value = item.unitPrice || "";
                if(item.splitData) {
                    for(let family in item.splitData) {
                        const input = document.getElementById(`qty-${family}`);
                        if(input) input.value = item.splitData[family].qty;
                    }
                    calcTotal();
                }
                routeBtn.style.display = 'none';
                window.updateMapPreview(item.location);
            } else {
                ['locInput','timeInput','durationInput','noteInput','travelTimeInput','unitPriceInput'].forEach(i => document.getElementById(i).value = '');
                document.getElementById('transportInput').value = "ç„¡";
                calcTotal(); // è§¸ç™¼é è¨­è¨ˆç®—
                if(currentData.length > 0) {
                    routeBtn.style.display = 'flex';
                    window.lastLoc = currentData[currentData.length - 1].location;
                } else { routeBtn.style.display = 'none'; }
            }
        }

        window.calcTotal = () => {
            const price = parseFloat(document.getElementById('unitPriceInput').value) || 0;
            let total = 0;
            document.querySelectorAll('.split-input').forEach(input => {
                const qty = parseFloat(input.value) || 0;
                total += qty * price;
            });
            document.getElementById('totalPriceDisplay').innerText = `ç¸½è¨ˆ: $${total.toLocaleString()}`;
        }

        window.updateMapPreview = (loc) => { const mapDiv = document.getElementById('mapPreview'); if(!loc) { mapDiv.innerHTML = "åœ°åœ–é è¦½å€"; return; } mapDiv.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://www.google.com/maps?q=${encodeURIComponent(loc)}&output=embed"></iframe>`; }
        window.openGoogleMapsRoute = () => { const current = document.getElementById('locInput').value; let url = `https://www.google.com/maps?q=${encodeURIComponent(window.lastLoc)}`; if(current) url += `&destination=${encodeURIComponent(current)}`; window.open(url, '_blank'); }

        window.saveItem = async () => {
            const id = document.getElementById('editId').value;
            const unitPrice = parseFloat(document.getElementById('unitPriceInput').value) || 0;
            let splitData = {}; let totalCost = 0;
            
            if(unitPrice > 0 && tripData.groups) {
                tripData.groups.forEach(family => {
                    const qty = parseFloat(document.getElementById(`qty-${family}`).value) || 0;
                    if(qty > 0) { splitData[family] = { qty: qty, cost: qty * unitPrice }; totalCost += qty * unitPrice; }
                });
            }

            const data = {
                tripId: currentTripId, day: parseInt(currentDay),
                location: document.getElementById('locInput').value,
                time: document.getElementById('timeInput').value,
                duration: document.getElementById('durationInput').value,
                transport: document.getElementById('transportInput').value,
                travelDuration: document.getElementById('travelTimeInput').value,
                note: document.getElementById('noteInput').value,
                unitPrice, splitData, totalCost,
                createdBy: currentFamily // V14.0: ç´€éŒ„æ˜¯èª°æ–°å¢çš„
            };
            if(!data.location) return alert("åœ°é»å¿…å¡«");
            
            try { 
                if(id) {
                    if(!isEditor) return alert("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•ä¿®æ”¹");
                    await updateDoc(doc(db, "items", id), data);
                } else {
                    await addDoc(collection(db, "items"), { ...data, createdAt: serverTimestamp() });
                }
                closeAllModals(); 
            } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
        }

        window.delItem = async (id) => { if(!isEditor) return; if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "items", id)); }
        window.logout = () => { localStorage.clear(); location.reload(); }
        window.copyCode = () => { navigator.clipboard.writeText(currentTripId).then(()=>alert("ä»£ç¢¼å·²è¤‡è£½")); }
        
        window.changeDay = changeDay; window.openItemModal = openItemModal; window.closeAllModals = closeAllModals; window.saveItem = saveItem; window.delItem = delItem; window.openGoogleMapsRoute = openGoogleMapsRoute; window.loadByCode = loadByCode; window.showCreate = showCreate; window.backToStep1 = backToStep1; window.loginWithFamily = loginWithFamily; window.checkTripCode = checkTripCode; window.createNewTrip = createNewTrip; window.logout = logout; window.copyCode = copyCode; window.updateMapPreview = updateMapPreview; window.calcTotal = calcTotal; window.showMoneyModal = showMoneyModal;
    </script>
</body>
</html>
