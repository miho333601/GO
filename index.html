<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…ä¼´ Go! V10.3 (å®Œç¾é›™æ£²ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* === å…¨å±€è¨­å®š === */
        :root { --primary: #4285F4; --bg: #f8f9fa; --card-bg: #ffffff; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: #333; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* === ä½ˆå±€ === */
        .app-container { display: flex; width: 100%; height: 100%; flex-direction: column; }
        
        /* é›»è…¦ç‰ˆå´é‚Šæ¬„ */
        .sidebar { width: 280px; background: white; border-right: 1px solid #eee; display: none; flex-direction: column; padding: 20px; }
        .sidebar-btn { display: block; width: 100%; padding: 12px 15px; border: none; background: transparent; text-align: left; cursor: pointer; border-radius: 8px; font-size: 16px; color: #555; margin-bottom: 5px; transition: 0.2s; }
        .sidebar-btn:hover { background: #f1f3f4; }
        .sidebar-btn.active { background: #e8f0fe; color: var(--primary); font-weight: bold; }

        /* æ‰‹æ©Ÿç‰ˆå°èˆª */
        .mobile-header { background: white; padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10; }
        .app-title { font-weight: bold; font-size: 1.2em; color: var(--primary); margin: 0; }
        .trip-code { font-size: 0.8em; color: #999; background: #f1f3f4; padding: 4px 8px; border-radius: 12px; cursor: pointer; }

        .mobile-days-bar { display: flex; overflow-x: auto; background: white; padding: 10px 15px; border-bottom: 1px solid #eee; white-space: nowrap; gap: 10px; scrollbar-width: none; }
        .mobile-days-bar::-webkit-scrollbar { display: none; }
        .day-pill { display: inline-block; padding: 8px 16px; border-radius: 20px; background: #f1f3f4; color: #666; font-size: 0.95em; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
        .day-pill.active { background: var(--primary); color: white; box-shadow: 0 2px 6px rgba(66,133,244,0.3); }

        .main-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; position: relative; }

        /* å¡ç‰‡æ¨£å¼ */
        .spot-card { background: var(--card-bg); border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 0; display: flex; overflow: hidden; border: 1px solid #f0f0f0; position: relative; z-index: 2; }
        .time-col { width: 75px; background: #e8f0fe; color: #1967d2; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; font-weight: 700; font-size: 0.95em; text-align: center; border-right: 1px solid #dbeafe; }
        .info-col { flex: 1; padding: 15px; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .spot-title { font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 0.8em; padding: 3px 8px; border-radius: 6px; background: #f5f5f5; color: #666; display: flex; align-items: center; gap: 4px; }
        .badge.stay { background: #e0f2f1; color: #00695c; }
        .badge.note { background: #fff3e0; color: #ef6c00; }
        
        .actions-col { width: 45px; border-left: 1px solid #f0f0f0; display: flex; flex-direction: column; }
        .act-btn { flex: 1; border: none; background: white; color: #ccc; font-size: 1.1em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .act-btn:hover { background: #f5f5f5; color: var(--primary); }
        .act-btn.del:hover { color: #d32f2f; background: #ffebee; }

        /* äº¤é€šé€£æ¥å™¨ */
        .transport-connector { display: flex; align-items: center; justify-content: center; padding: 12px 0; position: relative; }
        .transport-connector::before { content: ''; position: absolute; top: 0; bottom: 0; left: 37px; width: 2px; background: repeating-linear-gradient(to bottom, #ddd 0, #ddd 6px, transparent 6px, transparent 12px); z-index: 0; }
        .transport-pill { background: white; border: 1px solid #eee; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; color: #666; position: relative; z-index: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.03); display: flex; align-items: center; gap: 6px; }
        .transport-pill i { color: var(--primary); }

        .fab-btn { position: absolute; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; border: none; box-shadow: 0 4px 15px rgba(66,133,244,0.4); font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; z-index: 100; }
        .fab-btn:active { transform: scale(0.9); }

        /* === è¦–çª—æ ¸å¿ƒ CSS (V10.3 ä¿®æ­£ç‰ˆ) === */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; opacity: 0; transition: opacity 0.3s; }
        
        .modal-sheet { 
            position: fixed; bottom: -100%; left: 0; width: 100%; 
            background: white; border-radius: 20px 20px 0 0; padding: 25px; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000; 
            transition: bottom 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); 
            max-height: 90vh; overflow-y: auto; 
        }
        
        .modal-active .modal-overlay { display: block; opacity: 1; }
        .modal-active .modal-sheet { bottom: 0; }

        /* è¡¨å–®å…ƒä»¶ */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9em; font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; background: #fff; appearance: none; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .btn-full { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-cancel { background: #f1f3f4; color: #333; margin-top: 10px; }
        .btn-map { background: #e8f0fe; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px;}

        /* === æ­¡è¿é  (V10.3 å„ªåŒ–) === */
        #landing { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; text-align: center; }
        
        /* æ­¡è¿é æŒ‰éˆ•å®¹å™¨ */
        .landing-options { width: 100%; max-width: 300px; }
        /* è¼¸å…¥è¡¨å–® (é è¨­éš±è—) */
        .landing-form { display: none; width: 100%; max-width: 300px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .landing-input { width: 100%; padding: 15px; font-size: 18px; text-align: center; border: 2px solid #eee; border-radius: 12px; margin-bottom: 15px; }

        /* === RWD: é›»è…¦ç‰ˆé—œéµä¿®æ­£ (è§£æ±ºè¦–çª—å¡ä½å•é¡Œ) === */
        @media (min-width: 769px) {
            .app-container { flex-direction: row; }
            .sidebar { display: flex; }
            .mobile-header, .mobile-days-bar { display: none; }
            
            /* V10.3: é›»è…¦ç‰ˆè¦–çª—å¼·åˆ¶ç½®ä¸­ */
            .modal-sheet { 
                width: 450px; 
                left: 50%; 
                top: 50%; /* ä½¿ç”¨ Top å®šä½ */
                bottom: auto !important; /* å¼·åˆ¶å–æ¶ˆ Bottom å®šä½ */
                transform: translate(-50%, -50%) scale(0.95); /* åˆå§‹ç‹€æ…‹ç¸®å°ä¸€é» */
                border-radius: 16px; 
                opacity: 0; 
                pointer-events: none;
                transition: opacity 0.3s, transform 0.3s;
            }
            .modal-active .modal-sheet { 
                opacity: 1; 
                pointer-events: auto;
                bottom: auto !important;
                transform: translate(-50%, -50%) scale(1); /* é¡¯ç¤ºæ™‚æ”¾å¤§å›æ­£å¸¸ */
            }
        }
    </style>
</head>
<body>

    <div id="landing">
        <h1 style="color:var(--primary); font-size: 2.5em; margin-bottom: 10px;">æ—…ä¼´ Go!</h1>
        <p style="color:#888; margin-bottom: 40px;">è¼•é¬†è¦åŠƒï¼Œå³æ™‚åŒæ­¥</p>
        
        <div id="landingOptions" class="landing-options">
            <button class="btn-full btn-primary" onclick="showLandingForm('login')">æˆ‘æœ‰ä»£ç¢¼ï¼Œè¼‰å…¥è¡Œç¨‹</button>
            <button class="btn-full btn-cancel" onclick="showLandingForm('create')">å»ºç«‹æ–°è¡Œç¨‹</button>
        </div>

        <div id="landingLogin" class="landing-form">
            <input type="text" id="codeEnter" class="landing-input" placeholder="è«‹è¼¸å…¥ 6 ä½æ•¸ä»£ç¢¼">
            <button class="btn-full btn-primary" onclick="loadByCode()">ç¢ºå®šè¼‰å…¥</button>
            <button class="btn-full btn-cancel" onclick="resetLanding()">è¿”å›</button>
        </div>

        <div id="landingCreate" class="landing-form">
            <input type="text" id="newTripName" class="landing-input" placeholder="æ—…ç¨‹åç¨± (ä¾‹ï¼šæ—¥æœ¬äº”æ—¥éŠ)" style="text-align:left;">
            <div class="form-group" style="text-align:left;">
                <label>å‡ºç™¼æ—¥æœŸ</label>
                <input type="date" id="newTripDate">
            </div>
            <div class="form-group" style="text-align:left;">
                <label>å¤©æ•¸</label>
                <input type="number" id="newTripDays" value="5">
            </div>
            <button class="btn-full btn-primary" onclick="createNewTrip()">é–‹å§‹è¦åŠƒ</button>
            <button class="btn-full btn-cancel" onclick="resetLanding()">è¿”å›</button>
        </div>
    </div>

    <div class="app-container" id="app" style="display:none;">
        <div class="sidebar">
            <h2 id="pcTripTitle">è¼‰å…¥ä¸­...</h2>
            <div id="pcDayList" class="sidebar-days"></div>
            <button class="btn-full btn-cancel" onclick="logout()">é€€å‡º</button>
        </div>

        <div style="flex:1; display:flex; flex-direction:column; height:100%;">
            <div class="mobile-header">
                <h3 class="app-title" id="mobileTripTitle">è¡Œç¨‹åç¨±</h3>
                <span class="trip-code" id="mobileCode" onclick="copyCode()">ä»£ç¢¼: ---</span>
            </div>
            <div class="mobile-days-bar" id="mobileDayList"></div>
            <div class="main-content" id="listArea">
                <div style="text-align:center; margin-top:50px; color:#ccc;">è®€å–ä¸­...</div>
            </div>
            <button class="fab-btn" onclick="openItemModal()"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay" onclick="closeAllModals()"></div>
    
    <div id="itemModalSheet" class="modal-sheet">
        <h3 style="margin-top:0; color:var(--primary);">ğŸ“ ç·¨è¼¯è¡Œç¨‹</h3>
        <input type="hidden" id="editId">
        <button class="btn-full btn-map" id="routeBtn" onclick="openGoogleMapsRoute()" style="display:none;"><i class="fas fa-map-marked-alt"></i> é–‹å•Ÿ Google Maps å°èˆª</button>
        <div class="form-group"><label>åœ°é»åç¨±</label><input type="text" id="locInput" placeholder="ä¾‹å¦‚ï¼šæ¸…æ°´å¯º"></div>
        <div class="row form-group">
            <div class="col"><label>åˆ°é”æ™‚é–“</label><input type="time" id="timeInput"></div>
            <div class="col"><label>åœç•™(åˆ†)</label><input type="number" id="durationInput" placeholder="60"></div>
        </div>
        <div class="form-group">
            <label>äº¤é€šæ–¹å¼ (å‰å¾€æ­¤è™•)</label>
            <div class="row">
                <div class="col" style="flex:2;">
                    <select id="transportInput">
                        <option value="ç„¡">ç„¡</option><option value="é–‹è»Š">ğŸš— é–‹è»Š</option><option value="å¤§çœ¾é‹è¼¸">ğŸš† å¤§çœ¾é‹è¼¸</option><option value="æ­¥è¡Œ">ğŸš¶ æ­¥è¡Œ</option><option value="å–®è»Š">ğŸš² å–®è»Š</option>
                    </select>
                </div>
                <div class="col" style="flex:1;"><input type="number" id="travelTimeInput" placeholder="è»Šç¨‹(åˆ†)"></div>
            </div>
        </div>
        <div class="form-group"><label>å‚™è¨»</label><input type="text" id="noteInput" placeholder="ç¥¨åƒ¹ã€è¨‚ä½ä»£è™Ÿ..."></div>
        <button class="btn-full btn-primary" onclick="saveItem()">å„²å­˜</button>
        <button class="btn-full btn-cancel" onclick="closeAllModals()">å–æ¶ˆ</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDoc, doc, query, where, onSnapshot, setDoc, serverTimestamp, updateDoc, deleteDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === æ‚¨çš„ Firebase è¨­å®š ===
        const firebaseConfig = {
            apiKey: "AIzaSyBYUTADnEjSDMd__T7n8xsoY5LFUn9qlDw",
            authDomain: "gogo-252ba.firebaseapp.com",
            projectId: "gogo-252ba",
            storageBucket: "gogo-252ba.firebasestorage.app",
            messagingSenderId: "599210924514",
            appId: "1:599210924514:web:15e78eb22c2b355e9b81bb",
            measurementId: "G-3VJRC7WZQB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentTripId = localStorage.getItem('lastTripId');
        let currentDay = 1;
        let unsubscribe = null;
        let currentData = [];

        // è‡ªå‹•ç™»å…¥æª¢æŸ¥ (å«éŒ¯èª¤è™•ç†)
        if(currentTripId) {
            // å¦‚æœæœ‰èˆŠä»£ç¢¼ï¼Œç›´æ¥å˜—è©¦ç™»å…¥
            tryLogin(currentTripId, true);
        }

        async function tryLogin(code, isAuto = false) {
            try {
                const snap = await getDoc(doc(db, "trips", code));
                if(snap.exists()) {
                    currentTripId = code;
                    localStorage.setItem('lastTripId', code);
                    initApp(snap.data());
                } else {
                    if(!isAuto) alert("æ‰¾ä¸åˆ°æ­¤è¡Œç¨‹ä»£ç¢¼");
                    localStorage.removeItem('lastTripId');
                }
            } catch (e) {
                console.error("Login Error:", e);
                // å¦‚æœæ˜¯ API æ¬Šé™éŒ¯èª¤ï¼Œé¡¯ç¤ºæ˜ç¢ºè¨Šæ¯
                if(e.code === 'permission-denied' || e.message.includes('permission-denied')) {
                    alert("âš ï¸ é€£ç·šè¢«æ‹’çµ•ï¼šAPI é‡‘é‘°è¨­å®šå°šæœªç”Ÿæ•ˆã€‚\n\nè«‹ç­‰å¾… 5~10 åˆ†é˜å¾Œå†é‡æ–°æ•´ç†ç¶²é ã€‚\n(é€™æ˜¯ Google Cloud çš„æ­£å¸¸ç”Ÿæ•ˆæ™‚é–“)");
                } else {
                    if(!isAuto) alert("é€£ç·šéŒ¯èª¤ï¼š" + e.message);
                }
                localStorage.removeItem('lastTripId');
            }
        }

        // V10.3 æ­¡è¿é æ§åˆ¶
        window.showLandingForm = (type) => {
            document.getElementById('landingOptions').style.display = 'none';
            if(type === 'login') document.getElementById('landingLogin').style.display = 'block';
            else document.getElementById('landingCreate').style.display = 'block';
        }

        window.resetLanding = () => {
            document.getElementById('landingOptions').style.display = 'block';
            document.getElementById('landingLogin').style.display = 'none';
            document.getElementById('landingCreate').style.display = 'none';
        }

        window.loadByCode = () => {
            const code = document.getElementById('codeEnter').value.trim();
            if(!code) return alert("è«‹è¼¸å…¥ä»£ç¢¼");
            tryLogin(code);
        }

        window.createNewTrip = async () => {
            const name = document.getElementById('newTripName').value;
            const date = document.getElementById('newTripDate').value;
            const days = document.getElementById('newTripDays').value;
            
            if(!name || !days) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

            const id = Math.floor(100000 + Math.random()*900000).toString();
            try {
                await setDoc(doc(db, "trips", id), { name, startDate: date, days: parseInt(days), createdAt: serverTimestamp() });
                currentTripId = id;
                localStorage.setItem('lastTripId', id);
                initApp({ name, days: parseInt(days) });
            } catch(e) {
                alert("å»ºç«‹å¤±æ•—ï¼š" + e.message);
            }
        }

        function initApp(data) {
            document.getElementById('landing').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            document.getElementById('mobileTripTitle').innerText = data.name;
            document.getElementById('pcTripTitle').innerText = data.name;
            document.getElementById('mobileCode').innerText = `ä»£ç¢¼: ${currentTripId}`;

            renderDayNav(data.days);
            changeDay(1);
        }

        function renderDayNav(totalDays) {
            const pcList = document.getElementById('pcDayList');
            const mobileList = document.getElementById('mobileDayList');
            pcList.innerHTML = ''; mobileList.innerHTML = '';

            for(let i=1; i<=totalDays; i++) {
                pcList.innerHTML += `<button id="pc-day-${i}" class="sidebar-btn" onclick="changeDay(${i})">Day ${i}</button>`;
                mobileList.innerHTML += `<div id="mobile-day-${i}" class="day-pill" onclick="changeDay(${i})">Day ${i}</div>`;
            }
        }

        window.changeDay = (d) => {
            currentDay = d;
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.day-pill').forEach(b => b.classList.remove('active'));
            
            const pcBtn = document.getElementById(`pc-day-${d}`);
            const mobileBtn = document.getElementById(`mobile-day-${d}`);
            if(pcBtn) pcBtn.classList.add('active');
            if(mobileBtn) {
                mobileBtn.classList.add('active');
                mobileBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            listenData();
        }

        function formatDuration(m) {
            if(!m) return "";
            const h = Math.floor(m / 60); const min = m % 60;
            return h > 0 ? `${h}æ™‚${min}åˆ†` : `${min}åˆ†é˜`;
        }

        function listenData() {
            if(unsubscribe) unsubscribe();
            const q = query(collection(db, "items"), where("tripId", "==", currentTripId));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                const listDiv = document.getElementById('listArea');
                listDiv.innerHTML = "";
                currentData = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if(data.day == currentDay) currentData.push({ id: doc.id, ...data });
                });

                currentData.sort((a, b) => (a.time || "23:59").localeCompare(b.time || "23:59"));

                if(currentData.length === 0) {
                    listDiv.innerHTML = "<div style='text-align:center;color:#ccc;margin-top:50px;'><i class='fas fa-map-signs' style='font-size:3em;opacity:0.3;'></i><br><br>é€™è£¡é‚„æ²’æœ‰è¡Œç¨‹<br>é»å³ä¸‹è§’ + æ–°å¢</div>";
                    return;
                }

                currentData.forEach((item, index) => {
                    if (index > 0 && item.transport && item.transport !== 'ç„¡') {
                        let icon = 'fas fa-arrow-down';
                        if(item.transport.includes('é–‹è»Š')) icon = 'fas fa-car';
                        else if(item.transport.includes('å¤§çœ¾')) icon = 'fas fa-subway';
                        else if(item.transport.includes('æ­¥')) icon = 'fas fa-walking';
                        
                        let timeHtml = item.travelDuration ? `<span>â±ï¸ ${formatDuration(item.travelDuration)}</span>` : '';
                        listDiv.innerHTML += `<div class="transport-connector"><div class="transport-pill"><i class="${icon}"></i> ${item.transport} ${timeHtml}</div></div>`;
                    }

                    const stayHtml = item.duration ? `<span class="badge stay"><i class="far fa-clock"></i> åœ ${formatDuration(item.duration)}</span>` : '';
                    const noteHtml = item.note ? `<span class="badge note"><i class="far fa-sticky-note"></i> ${item.note}</span>` : '';

                    listDiv.innerHTML += `
                        <div class="spot-card">
                            <div class="time-col"><div>${item.time || "--:--"}</div></div>
                            <div class="info-col"><div class="spot-title">${item.location}</div><div class="badges">${stayHtml}${noteHtml}</div></div>
                            <div class="actions-col">
                                <button class="act-btn" onclick="openItemModal('${item.id}')"><i class="fas fa-pen"></i></button>
                                <button class="act-btn del" onclick="delItem('${item.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                });
            }, (error) => {
                console.error("Listen Error:", error);
                document.getElementById('listArea').innerHTML = `<div style='text-align:center;color:red;margin-top:20px;'>è®€å–å¤±æ•—<br>API æ¬Šé™æ›´æ–°ä¸­...<br>è«‹ 5 åˆ†é˜å¾Œé‡æ–°æ•´ç†</div>`;
            });
        }

        // Modal æ§åˆ¶
        window.closeAllModals = () => {
            document.body.classList.remove('modal-active');
            document.getElementById('modalOverlay').style.display = 'none';
            
            // V10.3: é›»è…¦ç‰ˆéš±è—ä¿®æ­£ (Opacity)
            const sheets = document.querySelectorAll('.modal-sheet');
            sheets.forEach(s => { s.style.opacity = '0'; s.style.pointerEvents = 'none'; });
            
            // æ‰‹æ©Ÿç‰ˆéš±è—ä¿®æ­£ (Bottom)
            if(window.innerWidth < 769) {
                sheets.forEach(s => { s.style.opacity = '1'; s.style.pointerEvents = 'auto'; s.style.bottom = '-100%'; });
            }
        }

        window.openItemModal = (id = null) => {
            document.body.classList.add('modal-active');
            document.getElementById('modalOverlay').style.display = 'block';
            
            const sheet = document.getElementById('itemModalSheet');
            // V10.3: é›»è…¦ç‰ˆé¡¯ç¤ºä¿®æ­£ (Opacity)
            if(window.innerWidth >= 769) {
                sheet.style.opacity = '1';
                sheet.style.pointerEvents = 'auto';
            } else {
                sheet.style.bottom = '0';
            }

            document.getElementById('editId').value = id || "";
            const routeBtn = document.getElementById('routeBtn');
            
            if(id) {
                const item = currentData.find(x => x.id === id);
                document.getElementById('locInput').value = item.location;
                document.getElementById('timeInput').value = item.time;
                document.getElementById('durationInput').value = item.duration || "";
                document.getElementById('transportInput').value = item.transport || "ç„¡";
                document.getElementById('travelTimeInput').value = item.travelDuration || "";
                document.getElementById('noteInput').value = item.note || "";
                routeBtn.style.display = 'none';
            } else {
                ['locInput','timeInput','durationInput','noteInput','travelTimeInput'].forEach(i => document.getElementById(i).value = '');
                document.getElementById('transportInput').value = "ç„¡";
                if(currentData.length > 0) {
                    routeBtn.style.display = 'flex';
                    window.lastLoc = currentData[currentData.length - 1].location;
                } else {
                    routeBtn.style.display = 'none';
                }
            }
        }

        window.openGoogleMapsRoute = () => {
            const current = document.getElementById('locInput').value;
            let url = `https://www.google.com/maps?q=${encodeURIComponent(window.lastLoc)}`;
            if(current) url += `&destination=${encodeURIComponent(current)}`;
            window.open(url, '_blank');
        }

        window.saveItem = async () => {
            const id = document.getElementById('editId').value;
            const data = {
                tripId: currentTripId, day: parseInt(currentDay),
                location: document.getElementById('locInput').value,
                time: document.getElementById('timeInput').value,
                duration: document.getElementById('durationInput').value,
                transport: document.getElementById('transportInput').value,
                travelDuration: document.getElementById('travelTimeInput').value,
                note: document.getElementById('noteInput').value
            };
            if(!data.location) return alert("åœ°é»å¿…å¡«");
            
            try {
                if(id) await updateDoc(doc(db, "items", id), data);
                else await addDoc(collection(db, "items"), { ...data, createdAt: serverTimestamp() });
                closeAllModals();
            } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
        }

        window.delItem = async (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "items", id)); }
        window.logout = () => { localStorage.removeItem('lastTripId'); location.reload(); }
        window.copyCode = () => { navigator.clipboard.writeText(currentTripId).then(()=>alert("ä»£ç¢¼å·²è¤‡è£½")); }
        
        // Export
        window.changeDay = changeDay;
        window.openItemModal = openItemModal;
        window.closeAllModals = closeAllModals;
        window.saveItem = saveItem;
        window.delItem = delItem;
        window.openGoogleMapsRoute = openGoogleMapsRoute;
        window.loadByCode = loadByCode;
        window.showLandingForm = showLandingForm;
        window.resetLanding = resetLanding;
        window.createNewTrip = createNewTrip;
        window.logout = logout;
        window.copyCode = copyCode;
    </script>
</body>
</html>
